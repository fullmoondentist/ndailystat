<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DailyStat - DentRSU</title>

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;300;400&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            rsu: {
              blue: '#1e40af',
              light: '#dbeafe',
              dark: '#1e3a8a'
            }
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer base {
      * {
        @apply leading-tight;
      }
      body {
        @apply leading-tight overflow-x-hidden;
      }
      html {
        @apply overflow-x-hidden;
      }
    }
    @layer components {
            .glass-card {
                @apply bg-white/90 backdrop-blur-md border border-white/20 shadow-md rounded-2xl;
            }
            .nav-item {
                @apply flex flex-col items-center justify-center pt-2 pb-1 text-xs font-medium transition-colors duration-200;
            }
            .nav-item.active {
                @apply text-blue-600;
            }
            .nav-item:not(.active) {
                @apply text-gray-400 hover:text-gray-600;
            }
            .stat-value {
                @apply text-2xl font-bold text-gray-900;
            }
            .stat-label {
                @apply text-xs uppercase font-bold text-gray-400;
            }
            .rank-badge {
                @apply px-3 py-1 rounded-full text-xs font-bold text-white;
            }
            /* Custom Gradients from DailyRemover */
            .premium-gradient {
                @apply bg-gradient-to-r from-pink-500 via-fuchsia-600 to-purple-600;
            }
            .ticker-wrap {
                @apply w-full overflow-hidden bg-gray-900/5 py-2;
            }
            .ticker-move {
                display: inline-block;
                white-space: nowrap;
                padding-right: 100%;
                animation: ticker 90s linear infinite;
            }
            @keyframes ticker {
                0% { transform: translate3d(100vw, 0, 0); }
                100% { transform: translate3d(-100%, 0, 0); }
            }
            @keyframes shimmer {
                0% { transform: translateX(-150%) skewX(-15deg); }
                100% { transform: translateX(150%) skewX(-15deg); }
            }
            .animate-shimmer {
                animation: shimmer 6s infinite;
            }
            @keyframes pulse-glow {
                0%, 100% { opacity: 0.5; filter: blur(8px); }
                50% { opacity: 0.8; filter: blur(12px); }
            }
            .animate-pulse-glow {
                animation: pulse-glow 3s ease-in-out infinite;
            }
            .pattern-hexagon {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23ffffff' fill-opacity='0.05' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9l11 6.35 11-6.35V31.1l-11 6.35-11-6.35V17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L12.98 41v8h-2v-6.85L0 35.81v-2.3zM15 0v7.5L27.99 15H28v-2.31h-.01L17 6.35V0h-2zm0 49v-8l12.99-7.5H28v2.31h-.01L17 42.15V49h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }
            .pattern-stripes {
                background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.03) 20px);
            }
            .pattern-crystal {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40' fill='%23ffffff' fill-opacity='0.05'/%3E%3C/svg%3E");
            }
            [x-cloak] { display: none !important; }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-900 font-sans pb-24" x-data="dailyApp()" x-init="init()">


  <!-- MAIN_CONTENT_CONTAINER START -->
  <main class="px-5 mt-4 relative z-20 space-y-4">

    <!-- DYNAMIC_VIEWS START -->
    <div x-cloak>

      <!-- DASHBOARD_VIEW START -->
      <div x-show="activeTab === 'dashboard'" class="space-y-4">

        <!-- TOP_HEADER START -->
        <header class="relative px-6 py-6 mt-2 text-white"
          :class="(showClassTooltip || showTitleTooltip ? 'z-[80]' : 'z-20')">

          <!-- Background Layer (Clipped) -->
          <div class="absolute inset-0 rounded-2xl overflow-hidden shadow-lg -z-10"
            :class="(rankConfig[profile.current_class]?.color || 'from-gray-400 to-gray-500') + ' bg-gradient-to-br ' + (profile.current_class === 'Diamond' ? ' shadow-[0_0_20px_rgba(56,189,248,0.4)]' : '')">

            <!-- Dynamic Background Pattern Layer -->
            <div class="absolute inset-0 opacity-10 pointer-events-none" :class="{
                'pattern-hexagon': profile.current_class === 'Diamond' || profile.current_class === 'Platinum',
                'pattern-crystal': profile.current_class === 'Gold',
                'pattern-stripes': profile.current_class === 'Silver' || profile.current_class === 'Bronze'
              }">
            </div>

            <!-- Shimmer Sweep Effect for Diamond/Platinum -->
            <div x-show="profile.current_class === 'Diamond' || profile.current_class === 'Platinum'"
              class="absolute inset-0 opacity-20 pointer-events-none overflow-hidden rounded-2xl">
              <div
                class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent w-1/2 -skew-x-12 animate-shimmer">
              </div>
            </div>

            <!-- Clipped Background Effects -->
            <div class="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none">
              <div class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
              <div class="absolute bottom-0 left-0 -ml-10 -mb-10 w-48 h-48 bg-blue-400/20 rounded-full blur-2xl"></div>
            </div>
          </div>

          <div class="relative z-10 flex justify-between items-stretch">

            <div class="flex items-center gap-4">
              <!-- Profile Picture with Dynamic Frame -->
              <div class="relative group">
                <!-- Aura Glow for Diamond -->
                <div x-show="profile.current_class === 'Diamond'"
                  class="absolute -inset-1 bg-cyan-400 rounded-full blur-md opacity-50 animate-pulse-glow"></div>

                <div
                  class="w-20 h-20 rounded-full border-2 overflow-hidden shadow-lg relative bg-white/20 flex-shrink-0 transition-all duration-500"
                  :class="{
                    'border-cyan-200 ring-4 ring-cyan-500/30 scale-105': profile.current_class === 'Diamond',
                    'border-yellow-200 ring-2 ring-yellow-400/40': profile.current_class === 'Gold',
                    'border-emerald-200 ring-2 ring-emerald-400/30': profile.current_class === 'Platinum',
                    'border-white/50': !['Diamond', 'Gold', 'Platinum'].includes(profile.current_class)
                  }">
                  <template x-if="profile.pictureUrl">
                    <img :src="profile.pictureUrl" class="w-full h-full object-cover">
                  </template>
                  <template x-if="!profile.pictureUrl">
                    <div class="w-full h-full flex items-center justify-center text-xl font-bold bg-white/10 uppercase"
                      x-text="profile.display_name?.charAt(0) || '?' "></div>
                  </template>
                </div>
              </div>

              <div class="text-left flex flex-col justify-center">
                <div class="flex items-center gap-2">
                  <span class="text-xl leading-tight font-light"
                    style="font-family: 'Kanit', sans-serif; font-weight: 300;"
                    x-text="profile.display_name || 'Loading...'"></span>
                </div>
                <p class="text-[11px] opacity-70 mt-0.5 font-medium"
                  x-text="profile.email ? profile.email.split('@')[0] : ''"></p>
                <div class="flex items-center gap-1 mt-1 opacity-90">
                  <span x-html="deptIconMap[profile.department] || '<i class=\'fa-solid fa-building-user\'></i>'"
                    class="text-xs text-blue-200"></span>
                  <span class="text-[11px] font-bold uppercase" x-text="profile.department || 'DentRSU'"></span>
                </div>
              </div>
            </div>

            <div class="flex flex-col items-end justify-between text-right">

              <div @click="showClassTooltip = !showClassTooltip" @click.outside="showClassTooltip = false"
                class="flex items-center justify-end gap-1 w-fit ml-auto bg-transparent cursor-pointer relative transition-transform active:scale-95"
                :class="showClassTooltip ? 'z-[70]' : 'z-10'">
                <span class="text-base" x-text="rankConfig[profile.current_class]?.emoji || 'â–«ï¸'"></span>
                <span x-text="profile.current_class || 'Beginner'" class="text-xs font-bold uppercase"></span>

                <!-- Class Tooltip -->
                <div x-show="showClassTooltip" x-cloak x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                  class="absolute top-full right-0 mt-2 z-[60] w-60 origin-top-right">
                  <div class="bg-gray-800 text-white text-[11px] p-3 rounded-xl shadow-xl relative">
                    <div class="absolute bottom-full right-4 border-4 border-transparent border-b-gray-800"></div>

                    <!-- Close Button -->
                    <button @click.stop="showClassTooltip = false"
                      class="absolute top-2 left-2 text-gray-400 hover:text-white transition-colors">
                      <i class="fa-solid fa-xmark text-sm"></i>
                    </button>

                    <div class="font-bold text-blue-300 mb-2 uppercase text-xs">Class: Precision Rank</div>

                    <div class="space-y-1.5">
                      <template x-for="cls in classProgression" :key="cls.name">
                        <div class="flex items-center gap-2 px-2 py-1 rounded-lg transition-colors text-xs"
                          :class="cls.isCurrent ? 'bg-yellow-500/20 text-yellow-300 font-bold' : 'text-gray-300'">
                          <span x-text="cls.order + '.'"></span>
                          <span x-text="cls.emoji"></span>
                          <span x-text="cls.name"></span>
                          <span class="text-[11px] opacity-60"
                            x-text="cls.minPrecision !== null ? '(' + cls.minPrecision + '-' + cls.maxPrecision + '%)' : '(Entries â‰¤ 20)'">
                          </span>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>

              <div @click="showTitleTooltip = !showTitleTooltip" @click.outside="showTitleTooltip = false"
                class="cursor-pointer relative transition-transform active:scale-95"
                :class="showTitleTooltip ? 'z-[70]' : 'z-10'">

                <div class="text-2xl leading-tight scale-110 origin-right drop-shadow-sm filter py-1"
                  x-text="profile.current_title ? profile.current_title.replace(/[a-zA-Z].*/, '') : 'ðŸ”°'">
                </div>

                <div class="text-[11px] font-bold opacity-90 uppercase"
                  x-text="profile.current_title ? profile.current_title.replace(/^[^a-zA-Z]*/, '') : 'Rookie'">
                </div>

                <!-- Title Tooltip -->
                <div x-show="showTitleTooltip" x-cloak x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                  class="absolute top-full right-0 mt-2 z-[60] w-64 origin-top-right">
                  <div
                    class="bg-gray-800 text-white text-[11px] p-3 rounded-xl shadow-xl relative max-h-96 overflow-y-auto">
                    <div class="absolute bottom-full right-4 border-4 border-transparent border-b-gray-800"></div>

                    <!-- Close Button -->
                    <button @click.stop="showTitleTooltip = false"
                      class="absolute top-2 left-2 text-gray-400 hover:text-white transition-colors z-10">
                      <i class="fa-solid fa-xmark text-sm"></i>
                    </button>

                    <div class="font-bold text-blue-300 mb-2 uppercase text-xs">Title: Experience Rank</div>

                    <div class="space-y-1.5">
                      <template x-for="phase in titleProgression" :key="phase.name">
                        <div>
                          <!-- Main Phase -->
                          <div class="flex items-center gap-2 px-2 py-1 rounded-lg transition-colors text-xs"
                            :class="phase.isCurrentPhase ? 'bg-yellow-500/20 text-yellow-300 font-bold' : 'text-gray-300'">
                            <span x-text="phase.order + '.'"></span>
                            <span x-text="phase.emoji"></span>
                            <span x-text="phase.name"></span>
                            <span class="text-[11px] opacity-60"
                              x-text="'(' + (phase.min || 0).toLocaleString() + (phase.max ? '-' + phase.max.toLocaleString() : '+') + ')'">
                            </span>
                          </div>

                          <!-- Tiers (if exists) -->
                          <div x-show="phase.tiers.length > 0" class="ml-6 mt-0.5 space-y-1">
                            <template x-for="tier in phase.tiers" :key="tier.tier">
                              <div
                                class="flex items-center gap-1.5 px-2 py-0.5 rounded-lg transition-colors text-[11px]"
                                :class="phase.currentTier?.tier === tier.tier ? 'bg-yellow-500/15 text-yellow-200 font-bold' : 'text-gray-400'">
                                <span>â€¢</span>
                                <span x-show="tier.icon" x-text="tier.icon"></span>
                                <span x-text="tier.tier"></span>
                                <span class="opacity-60"
                                  x-text="'(' + tier.min.toLocaleString() + '-' + tier.max.toLocaleString() + ')'">
                                </span>
                              </div>
                            </template>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>

            </div>

          </div>
        </header>
        <!-- TOP_HEADER END -->

        <!-- DASHBOARD_STATS_ROW START -->
        <div class="grid grid-cols-3 gap-3">
          <!-- Accuracy Card -->
          <div @click="activeInfo = (activeInfo === 'accuracy' ? null : 'accuracy')"
            @click.outside="activeInfo === 'accuracy' && (activeInfo = null)"
            class="glass-card p-3 flex flex-col items-center transition-all duration-300 relative cursor-pointer active:scale-95"
            :class="[getAccStyles(profile.recent_acc).card, activeInfo === 'accuracy' ? 'ring-2 ring-blue-400 z-[60]' : 'z-10']">
            <div class="stat-label">Accuracy</div>
            <div class="stat-value font-bold" :class="getAccStyles(profile.recent_acc).text"
              x-text="(profile.recent_acc || 0) + '%'"></div>

            <!-- Accuracy Tooltip -->
            <div x-show="activeInfo === 'accuracy'" x-cloak x-transition
              class="absolute top-full left-0 right-0 mt-2 z-50 bg-gray-900/95 text-white p-3 rounded-xl shadow-2xl text-[10px] leading-tight text-left min-w-[160px]">
              <div class="font-bold text-blue-300 mb-1 uppercase text-xs">Scoring Criteria</div>
              <div class="text-[10px] text-gray-400 mb-2 italic">Î” from session-end time</div>
              <div class="space-y-1 opacity-90">
                <p>â€¢ Perfect (100): On time (-120m to +60m)</p>
                <p>â€¢ Good (50): Late < 4 hrs</p>
                    <p>â€¢ Fair (25): Late > 4 hrs (Same day)</p>
                    <p>â€¢ Overdue (0): After day</p>
              </div>
              <div class="absolute -top-1 left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900/95">
              </div>
            </div>
          </div>

          <!-- All-time Acc Card -->
          <div @click="activeInfo = (activeInfo === 'alltime' ? null : 'alltime')"
            @click.outside="activeInfo === 'alltime' && (activeInfo = null)"
            class="glass-card p-3 flex flex-col items-center transition-all duration-300 relative cursor-pointer active:scale-95"
            :class="[getAccStyles(profile.alltime_acc).card, activeInfo === 'alltime' ? 'ring-2 ring-blue-400 z-[60]' : 'z-10']">
            <div class="stat-label truncate w-full text-center">All-time Acc</div>
            <div class="stat-value font-bold" :class="getAccStyles(profile.alltime_acc).text"
              x-text="(profile.alltime_acc || 0) + '%'"></div>

            <!-- All-time Tooltip -->
            <div x-show="activeInfo === 'alltime'" x-cloak x-transition
              class="absolute top-full left-0 right-0 mt-2 z-50 bg-gray-900/95 text-white p-3 rounded-xl shadow-2xl text-[10px] leading-tight text-center min-w-[140px]">
              Avg accuracy from all your submissions.
              <div class="absolute -top-1 left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900/95">
              </div>
            </div>
          </div>

          <!-- Consistency Card -->
          <div @click="activeInfo = (activeInfo === 'consistency' ? null : 'consistency')"
            @click.outside="activeInfo === 'consistency' && (activeInfo = null)"
            class="glass-card p-3 flex flex-col items-center transition-all duration-300 relative cursor-pointer active:scale-95"
            :class="activeInfo === 'consistency' ? 'ring-2 ring-orange-400 z-[60]' : 'z-10'">
            <div class="stat-label">Consistency</div>
            <div class="stat-value text-orange-500 font-bold">
              <span x-text="profile.current_consistency || 0"></span>
              <i class="fa-solid fa-fire text-sm ml-0.5"></i>
            </div>

            <!-- Consistency Tooltip -->
            <div x-show="activeInfo === 'consistency'" x-cloak x-transition
              class="absolute top-full right-0 mt-2 z-50 bg-gray-900/95 text-white p-3 rounded-xl shadow-2xl text-[10px] leading-tight text-center min-w-[140px] origin-top-right">
              <div class="font-bold text-orange-300 mb-1 uppercase text-xs">Streak Bonus</div>
              <div class="text-[10px] text-gray-400 mb-2 italic">Condition: Daily Acc â‰¥ 95%</div>
              <div class="grid grid-cols-2 gap-x-2 text-left opacity-90">
                <div>1d: +10%</div>
                <div>2d: +20%</div>
                <div>3d: +30%</div>
                <div>4d: +40%</div>
                <div class="col-span-2 text-center font-bold text-orange-400">5d+: +50% (Max)</div>
              </div>
              <div class="absolute -top-1 right-4 border-4 border-transparent border-b-gray-900/95">
              </div>
            </div>
          </div>
        </div>
        <!-- DASHBOARD_STATS_ROW END -->

        <!-- TICKER_MESSAGES START -->
        <div class="ticker-wrap rounded-xl" x-show="system.ticker_messages?.length > 0">
          <div class="ticker-move text-[11px] font-bold text-blue-900/60 uppercase">
            <template x-for="msg in system.ticker_messages" :key="msg">
              <span class="mx-8 flex-inline items-center">
                <i class="fa-solid fa-bullhorn mr-2"></i>
                <span x-text="msg"></span>
              </span>
            </template>
          </div>
        </div>
        <!-- TICKER_MESSAGES END -->

        <!-- EXPERIENCE_PROGRESS START -->
        <div @click="activeInfo = (activeInfo === 'experience' ? null : 'experience')"
          @click.outside="activeInfo === 'experience' && (activeInfo = null)"
          class="glass-card p-4 relative cursor-pointer transition-all duration-300 active:scale-[0.98]"
          :class="activeInfo === 'experience' ? 'ring-2 ring-purple-400 z-[60]' : 'z-10'">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
              <i class="fa-solid fa-bars-progress text-purple-500"></i>
              Experience
            </h3>
            <span class="text-xs font-bold text-gray-700" x-text="profile.current_title"></span>
          </div>
          <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden mb-2">
            <div class="h-full premium-gradient transition-all duration-1000 rounded-full"
              :style="'width: ' + (showExp ? expPercentage : 0) + '%'">
            </div>
          </div>
          <div class="flex justify-between text-xs font-bold text-gray-400">
            <span x-text="profile.total_exp?.toLocaleString() + ' EXP'"></span>
            <span
              x-text="profile.next_rank_exp ? 'Next: ' + (profile.next_rank_name || '') + ' (' + profile.next_rank_exp.toLocaleString() + ' EXP)' : 'Next: MAX'"></span>
          </div>

          <!-- Experience Tooltip -->
          <div x-show="activeInfo === 'experience'" x-cloak x-transition
            class="absolute top-full left-4 right-4 mt-2 z-50 bg-gray-900/95 text-white p-3 rounded-xl shadow-2xl text-[10px] leading-tight text-left">
            <div class="font-bold text-purple-300 mb-1 uppercase text-xs">EXP Breakdown</div>
            <div class="grid grid-cols-2 gap-x-4 gap-y-1 opacity-90">
              <p>â€¢ <b>Per Entry:</b> +100 (Perfect) / +50 (Good) / +25 (Fair)</p>
              <p>â€¢ <b>Bonus:</b> +100 EXP (if Daily Acc â‰¥ 95%)</p>
              <p>â€¢ <b>Consistency:</b> Up to +50% Bonus</p>
            </div>
            <div class="absolute -top-1 left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900/95">
            </div>
          </div>
        </div>
        <!-- EXPERIENCE_PROGRESS END -->



        <!-- ACCURACY_TREND_GRAPH START -->
        <div class="glass-card p-4 pb-5 overflow-hidden">
          <div class="flex justify-between items-end mb-2">
            <h3 class="text-sm font-bold text-gray-800"><i
                class="fa-solid fa-chart-area text-cyan-600 mr-2"></i>Accuracy
              Trend</h3>
            <div class="flex items-center gap-1.5" x-show="profile.daily_history?.length > 1">
              <span class="text-xs font-bold text-slate-700" x-text="(profile.alltime_acc || 0) + '%'"></span>
              <i class="fa-solid" :class="{
                   'fa-caret-up text-emerald-500': trendDirection === 'up',
                   'fa-caret-down text-rose-500': trendDirection === 'down',
                   'fa-minus text-gray-300': trendDirection === 'none'
                 }"></i>
            </div>
          </div>

          <div class="h-16 w-full relative" x-show="profile.daily_history && profile.daily_history.length > 1">
            <svg class="w-full h-full overflow-visible animate-reveal-graph" viewBox="0 -2 100 44"
              preserveAspectRatio="none">
              <defs>
                <linearGradient id="trendGradient" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.25" />
                  <stop offset="100%" stop-color="#3b82f6" stop-opacity="0" />
                </linearGradient>
              </defs>
              <!-- Area Fill -->
              <path :d="trendFill" fill="url(#trendGradient)" stroke="none" />
              <!-- Line -->
              <path :d="trendPath" fill="none" stroke="#2563eb" stroke-width="2" stroke-opacity="0.5"
                vector-effect="non-scaling-stroke" stroke-linecap="butt" stroke-linejoin="round" />
            </svg>
          </div>

          <div x-show="!profile.daily_history || profile.daily_history.length < 2"
            class="h-16 flex items-center justify-center text-xs text-gray-300 italic">
            Not enough data for trend graph
          </div>
        </div>
        <!-- ACCURACY_TREND_GRAPH END -->

        <!-- REWARD_BOX START -->
        <div class="glass-card p-4">
          <h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-gift text-rose-500"></i>
            Reward Box
          </h3>
          <div class="grid grid-cols-8 gap-2 relative">
            <template x-for="item in groupedRewards" :key="item.fullName">
              <div @click="selectedReward = (selectedReward?.fullName === item.fullName ? null : item)"
                @click.outside="if(selectedReward?.fullName === item.fullName) selectedReward = null"
                class="aspect-square flex items-center justify-center text-xl relative cursor-pointer rounded-lg transition-all duration-200"
                :class="selectedReward?.fullName === item.fullName ? 'bg-rose-50 ring-2 ring-rose-200 scale-110 z-10' : 'hover:bg-gray-50'">
                <span x-text="item.emoji"></span>
                <div x-show="item.count > 1" class="absolute -top-1 -right-1 text-gray-400 text-xs font-bold"
                  x-text="'Ã—' + item.count">
                </div>

                <!-- Tooltip Popup -->
                <div x-show="selectedReward?.fullName === item.fullName" x-cloak
                  x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                  class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 z-[60]">
                  <div
                    class="bg-gray-800 text-white text-xs p-3 rounded-xl shadow-xl relative min-w-[120px] text-center">
                    <div class="font-bold mb-2" x-text="item.displayName"></div>
                    <button @click.stop="sellReward(item)"
                      class="w-full py-1.5 px-3 bg-gradient-to-r from-rose-500 to-pink-500 text-white text-[10px] font-black rounded-lg shadow-md active:scale-95 transition-transform uppercase">
                      Exchange for EXP
                    </button>
                    <!-- Tooltip Arrow -->
                    <div
                      class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                    </div>
                  </div>
                </div>
              </div>
            </template>
            <div x-show="!profile.rewards?.length" class="col-span-8 py-8 text-center text-gray-300 text-xs italic">
              No rewards yet. Keep it up!
            </div>
          </div>
        </div>
        <!-- REWARD_BOX END -->
      </div>
      <!-- DASHBOARD_VIEW END -->

      <!-- LEADERBOARD_VIEW START -->
      <div x-show="activeTab === 'ranking'" class="space-y-3">

        <!-- DEPARTMENT_COMPARISON_CHART START -->
        <div class="glass-card p-4 sticky top-0 z-30 shadow-md">
          <h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-square-poll-horizontal text-blue-600"></i>
            Department All-time Accuracy
          </h3>
          <div class="space-y-2 mt-4">
            <template x-for="stat in orderedDeptStats" :key="stat.name">
              <div class="flex items-center gap-3">

                <!-- Department Name & Icon -->
                <div class="w-16 text-xs font-bold text-gray-500 flex items-center justify-end gap-1.5 shrink-0">
                  <span x-text="stat.name"></span>
                  <span x-html="deptIconMap[stat.name]" class="text-xs opacity-70"></span>
                </div>

                <!-- Progress Bar -->
                <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden relative">
                  <div class="h-full rounded-full transition-all duration-[1500ms] cubic-bezier(0.4, 0, 0.2, 1)"
                    :style="`width: ${showDeptAnim ? stat.accuracy : 0}%;`" :class="stat.name === profile.department
                      ? 'bg-gradient-to-r from-blue-600 to-sky-400 shadow-[0_0_8px_rgba(56,189,248,0.6)]'
                      : 'bg-gradient-to-r from-slate-300 to-slate-400 opacity-60'">
                  </div>
                </div>

                <!-- Percentage -->
                <div class="w-8 text-[12px] font-bold text-gray-400 text-right shrink-0" x-text="stat.accuracy + '%'">
                </div>

              </div>
            </template>
          </div>
        </div>
        <!-- DEPARTMENT_COMPARISON_CHART END -->

        <!-- LEADERBOARD_LIST START -->
        <div class="glass-card p-4 overflow-hidden">
          <div class="flex flex-col gap-4 mb-4">
            <div class="flex justify-between items-center">
              <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-ranking-star text-orange-600"></i>
                Leaderboard
              </h3>
              <div class="flex items-center gap-2" x-show="allowToggleAllLeaderboard">
                <span class="text-[10px] font-bold text-gray-400 uppercase"
                  x-text="showAllLeaderboard ? 'All Instructors' : 'Top 10'"></span>
                <button @click="showAllLeaderboard = !showAllLeaderboard"
                  class="w-10 h-5 rounded-full bg-gray-100 relative transition-colors duration-300"
                  :class="showAllLeaderboard ? 'bg-blue-100' : 'bg-gray-100'">
                  <div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-transform duration-300 shadow-sm"
                    :class="showAllLeaderboard ? 'translate-x-5 bg-blue-600' : 'bg-gray-400'"></div>
                </button>
              </div>
            </div>
          </div>

          <!-- 100% CLUB SECTION -->
          <div x-show="clubMembers.length > 0" class="mb-6 px-1">
            <div class="flex items-center gap-2 mb-4">
              <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">The 100% Club</h3>
              <div class="flex-1 h-px bg-slate-100"></div>
            </div>

            <!-- CSS for Shimmer Animation -->
            <style>
              @keyframes shimmer {
                0% {
                  transform: translateX(-150%) skewX(-45deg);
                }

                100% {
                  transform: translateX(150%) skewX(-45deg);
                }
              }

              .animate-shimmer {
                animation: shimmer 3s infinite linear;
              }
            </style>

            <div class="grid grid-cols-2 gap-2">
              <template x-for="user in clubMembers" :key="user.email">
                <div
                  class="relative overflow-hidden flex items-center justify-between px-2 py-1 bg-gradient-to-b from-amber-50 to-amber-100 border border-amber-200 rounded-full shadow-sm shadow-amber-100/50 group cursor-default"
                  :class="user.email === profile.email ? 'ring-1 ring-amber-500 border-amber-400' : ''">

                  <!-- Shimmer Effect -->
                  <div class="absolute inset-0 pointer-events-none">
                    <div
                      class="absolute inset-0 bg-gradient-to-r from-transparent via-white/60 to-transparent w-full h-full animate-shimmer">
                    </div>
                  </div>

                  <div class="flex items-center gap-1 overflow-hidden relative z-10 w-full">
                    <!-- Crown Emoji -->
                    <span class="text-xs shrink-0 drop-shadow-sm">ðŸ‘‘</span>

                    <!-- Name (Tight & Truncated) -->
                    <span class="text-xs font-bold text-amber-950 truncate w-full -ml-0.5"
                      x-text="formatName(user.email)"></span>
                  </div>

                  <!-- Dept Icon (Matched with Challengers) -->
                  <div class="ml-1 text-[10px] text-amber-800 opacity-40 shrink-0 relative z-10"
                    x-html="deptIconMap[user.department] || '<i class=\'fa-solid fa-user\'></i>'"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- CHALLENGERS SECTION -->
          <div x-show="challengerMembers.length > 0">
            <div class="flex items-center gap-2 mb-4 px-1" x-show="clubMembers.length > 0">
              <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Challengers</h3>
              <div class="flex-1 h-px bg-slate-100"></div>
            </div>

            <div class="mt-2">
              <template x-for="(user, idx) in challengerMembers" :key="user.email">
                <div
                  class="flex items-center gap-3 p-3 border-b border-gray-100 last:border-0 hover:bg-slate-50 transition-colors rounded-lg"
                  :class="user.email === profile.email ? 'bg-blue-50/50' : ''">

                  <!-- Rank (Dense Ranking from user.rank calculated in JS) -->
                  <div class="w-8 h-8 flex items-center justify-center font-bold text-sm rounded-lg"
                    :class="user.rank === 2 ? 'bg-slate-100 text-slate-500' : (user.rank === 3 ? 'bg-orange-100 text-orange-700' : 'text-gray-400')">
                    <span x-text="user.rank"></span>
                  </div>

                  <!-- Info -->
                  <div class="flex-1">
                    <div class="text-sm font-bold text-gray-800 flex items-center gap-1.5">
                      <span x-text="formatName(user.email)"></span>
                      <span x-html="deptIconMap[user.department]" class="text-[10px] opacity-40"></span>
                    </div>
                    <div class="text-xs text-gray-400" x-text="user.current_title">
                    </div>
                  </div>

                  <!-- Score -->
                  <div class="text-right">
                    <div class="text-sm font-bold" :class="getAccStyles(user.recent_acc).text"
                      x-text="(user.recent_acc || 0) + '%'">
                    </div>
                    <div class="text-xs font-bold text-gray-300">Recent Accuracy</div>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Your Rank Summary (Bottom - Only if outside visible list and NOT in 100% Club) -->
          <div x-show="!showAllLeaderboard && myRank > leaderboardLimit && (profile.recent_acc || 0) < 100"
            class="mt-4 bg-blue-50/50 rounded-xl p-3 flex items-center justify-between border border-blue-100/50">
            <div class="flex items-center gap-3">
              <div
                class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center font-bold text-sm">
                <span x-text="myRank"></span>
              </div>
              <div>
                <div class="text-sm font-bold text-gray-800">You</div>
                <div class="text-xs text-gray-500">Keep going!</div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-sm font-bold text-blue-600" x-text="(profile.recent_acc || 0) + '%'"></div>
            </div>
          </div>

        </div>
      </div>
      <!-- LEADERBOARD_LIST END -->
    </div>
    <!-- LEADERBOARD_VIEW END -->


    <!-- PROFILE_VIEW START -->
    <div x-show="activeTab === 'profile'" class="space-y-4">
      <div class="glass-card py-4 px-5 relative z-30 flex items-center">
        <!-- Background Icon Clipping Layer -->
        <div class="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none z-0">
          <div class="absolute -bottom-6 -right-2 opacity-[0.1] text-gray-400 pointer-events-none"
            style="font-size: 100px; transform: rotate(-10deg);" x-html="deptIconMap[profile.department]">
          </div>
        </div>

        <div class="grid grid-cols-2 w-full relative z-10 items-center">
          <!-- Left side: Identity -->
          <div class="flex flex-col items-start gap-0">
            <h2 class="text-xl text-gray-800 font-light leading-tight flex items-baseline gap-2"
              style="font-family: 'Kanit', sans-serif; font-weight: 300;">
              <span x-text="profile.display_name"></span>
              <span class="flex items-center opacity-40">
                <span class="text-[12px] font-bold text-gray-500 uppercase"
                  x-text="profile.department || 'DentRSU'"></span>
              </span>
            </h2>

            <!-- Persona Badge -->
            <div @click="showPersonaTooltip = !showPersonaTooltip" @click.outside="showPersonaTooltip = false"
              class="mt-0.5 px-3 py-0 rounded-full bg-blue-50/50 border border-blue-100 flex items-center justify-center gap-1.5 w-max cursor-pointer relative transition-transform active:scale-95">
              <span class="text-xs" x-text="personaConfig.emoji"></span>
              <span class="text-xs font-bold uppercase text-blue-600" x-text="personaConfig.name"></span>

              <!-- Persona Tooltip -->
              <div x-show="showPersonaTooltip" x-cloak x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                class="absolute top-full left-0 mt-2 z-[60] w-48 origin-top-left">
                <div class="bg-gray-800 text-white text-[11px] p-3 rounded-xl shadow-xl relative">
                  <div class="absolute bottom-full left-4 border-4 border-transparent border-b-gray-800"></div>
                  <div class="font-bold text-blue-300 mb-1 uppercase text-xs" x-text="personaConfig.name"></div>
                  <div class="font-medium leading-tight text-gray-100" x-text="personaConfig.desc"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right side: Rank Stats -->
          <div class="flex flex-col items-end gap-1 text-right">
            <p class="text-xs font-bold text-gray-40" x-text="classDisplay"></p>
            <div class="text-xs font-bold text-blue-600/80" x-text="profile.current_title || '---'"></div>
          </div>
        </div>
      </div>

      <!-- PRECISION_DASHBOARD_V2_START -->
      <div class="space-y-4 px-0">
        <div class="grid grid-cols-2 gap-4">
          <!-- GRADING_VITALS_V2 -->
          <div class="glass-card p-3 flex flex-col items-center justify-center">
            <div class="stat-label">All Submissions</div>
            <div class="stat-value text-gray-700 font-bold">
              <span x-text="profile.total_cases_count || 0"></span>
              <span class="text-xs uppercase ml-1">Entries</span>
            </div>
          </div>

          <!-- AVG_PRECISION_V2 -->
          <div @click="activeInfo = (activeInfo === 'precision' ? null : 'precision')"
            @click.outside="activeInfo === 'precision' && (activeInfo = null)"
            class="glass-card p-3 relative flex flex-col items-center justify-center cursor-pointer transition-all duration-300 active:scale-95"
            :class="activeInfo === 'precision' ? 'ring-2 ring-indigo-400 z-[60]' : 'z-10'">
            <div class="w-full flex flex-col items-center text-center">
              <div class="stat-label">Same-date PRECISION</div>
              <div class="stat-value">
                <span :class="avgDelta <= 0 ? 'text-emerald-500' : 'text-orange-500'"
                  x-text="Math.abs(Math.round(avgDelta))"></span>
                <span class="text-gray-700 inline-flex items-baseline" x-show="sdDelta > 0">
                  <span class="text-xs font-bold opacity-30" x-text="'Â±' + Math.round(sdDelta)"></span>
                  <span class="text-xs ml-1">mins <span class="!normal-case !font-normal">xÌ„</span></span>
                </span>
              </div>
              <div class="text-[12px] font-bold mt-0.5">
                <span :class="avgDelta <= 0 ? 'text-emerald-500' : 'text-orange-500'"
                  x-text="avgDelta <= 0 ? 'BEFORE' : 'AFTER'"></span>
                <span class="text-gray-700">Session end</span>
              </div>
            </div>

            <!-- Precision Tooltip -->
            <div x-show="activeInfo === 'precision'" x-cloak x-transition
              class="absolute top-full left-0 right-0 mt-2 z-50 bg-gray-900/95 text-white p-3 rounded-xl shadow-2xl text-[10px] leading-tight text-center min-w-[140px]">
              Offset from session end.<br>Closer to 0 is better.
              <div class="absolute -top-1 left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900/95">
              </div>
            </div>
          </div>
        </div>

        <!-- ADAPTIVE_STATUS_OVERDUE_ROW -->
        <div class="flex gap-4 items-stretch">
          <!-- SUBMISSION_STATUS_BAR_CARD -->
          <div class="glass-card px-5 py-3 flex flex-col justify-center transition-all duration-500"
            :class="profile.total_overdue > 0 ? 'w-2/3' : 'w-full'">
            <div class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden flex shadow-inner">
              <div class="h-full bg-gradient-to-r from-emerald-500 to-teal-400 transition-all duration-1000"
                :style="'width: ' + (showProfileAnim ? onTimePercent : 0) + '%'"></div>
              <div class="h-full bg-gradient-to-r from-amber-400 to-orange-300 transition-all duration-1000"
                x-show="profile.total_too_early > 0" :style="'width: ' + (showProfileAnim ? tooEarlyPercent : 0) + '%'">
              </div>
              <div class="h-full bg-gradient-to-r from-rose-500 to-pink-400 transition-all duration-1000"
                :style="'width: ' + (showProfileAnim ? overduePercent : 0) + '%'"></div>
            </div>
            <div class="flex justify-between mt-3 text-xs font-bold uppercase leading-tight">
              <div class="flex flex-col">
                <span class="text-emerald-500 text-sm"
                  x-text="onTimePercent + '% (' + (profile.total_on_time || 0) + ')'"></span>
                <span class="text-emerald-500">ON-TIME</span>
              </div>
              <div class="flex flex-col items-center" x-show="profile.total_too_early > 0">
                <span class="text-amber-500 text-sm"
                  x-text="tooEarlyPercent + '% (' + (profile.total_too_early || 0) + ')'"></span>
                <span class="text-amber-500">TOO EARLY</span>
              </div>
              <div class="flex flex-col items-end">
                <span class="text-orange-500 text-sm"
                  x-text="overduePercent + '% (' + (profile.total_overdue || 0) + ')'"></span>
                <span class="text-orange-500">AFTER-DATE</span>
              </div>
            </div>
          </div>

          <!-- OVERDUE_REPORT_CARD (1/3 Width Adaptive) -->
          <div
            class="glass-card p-3 flex flex-col items-center justify-center !bg-rose-600 shadow-rose-200 w-1/3 border-rose-500"
            x-show="profile.total_overdue > 0">
            <div class="w-full flex flex-col items-center text-center">
              <div class="stat-label !text-white/70">DELAY <span class="!normal-case !font-normal">xÌ„</span></div>
              <div class="text-white text-sm font-bold" x-html="formatOverdueDelay(profile.avg_overdue_delay)"></div>
              <div class="text-[12px] font-bold text-white/70 uppercase mt-0.5"
                x-text="(profile.total_overdue || 0) + ' Entries'"></div>
            </div>
          </div>
        </div>

        <!-- SESSION_DISTRIBUTION_V2 -->
        <div class="glass-card p-3">
          <div class="flex items-center gap-2 mb-5">
            <i class="fa-solid fa-chart-simple text-blue-600/50"></i>
            <h3 class="text-sm font-bold text-gray-800">Session Distribution</h3>
          </div>

          <div class="space-y-2">
            <!-- MORNING -->
            <div>
              <div class="flex items-center gap-3">
                <div class="w-6 flex flex-col items-center shrink-0">
                  <i class="fa-solid fa-sun text-cyan-400 text-sm"></i>
                </div>
                <div class="flex-1 h-1.5 bg-gray-50 rounded-full overflow-hidden">
                  <div
                    class="h-full bg-gradient-to-r from-cyan-400 to-blue-400 rounded-full transition-all duration-1000"
                    :style="'width: ' + (showProfileAnim ? sessionDist.m : 0) + '%'"></div>
                </div>
                <div class="w-16 text-right leading-tight">
                  <span class="text-xs font-bold text-gray-400"
                    x-text="(profile.count_morning || 0) + ' entries'"></span>
                </div>
              </div>
              <div class="flex items-center gap-3 -mt-1">
                <div class="w-6"></div>
                <div class="flex-1 text-right">
                  <span :class="avgMorningSameday.isLate ? 'text-rose-500' : 'text-emerald-500'"
                    class="text-xs font-bold" x-text="'xÌ„ ' + avgMorningSameday.label"></span>
                  <span x-show="morningOverdueCount > 0" class="text-orange-500 text-xs font-bold ml-2"
                    x-text="'(' + morningOverdueCount + ' after-date)'"></span>
                </div>
              </div>
            </div>

            <!-- AFTERNOON -->
            <div>
              <div class="flex items-center gap-3">
                <div class="w-6 flex flex-col items-center shrink-0">
                  <i class="fa-solid fa-cloud-sun text-amber-400 text-sm"></i>
                </div>
                <div class="flex-1 h-1.5 bg-gray-50 rounded-full overflow-hidden">
                  <div
                    class="h-full bg-gradient-to-r from-amber-400 to-orange-300 rounded-full transition-all duration-1000"
                    :style="'width: ' + (showProfileAnim ? sessionDist.a : 0) + '%'"></div>
                </div>
                <div class="w-16 text-right leading-tight">
                  <span class="text-xs font-bold text-gray-400"
                    x-text="(profile.count_afternoon || 0) + ' entries'"></span>
                </div>
              </div>
              <div class="flex items-center gap-3 -mt-1">
                <div class="w-6"></div>
                <div class="flex-1 text-right">
                  <span :class="avgAfternoonSameday.isLate ? 'text-rose-500' : 'text-emerald-500'"
                    class="text-xs font-bold" x-text="'xÌ„ ' + avgAfternoonSameday.label"></span>
                  <span x-show="afternoonOverdueCount > 0" class="text-orange-500 text-xs font-bold ml-2"
                    x-text="'(' + afternoonOverdueCount + ' after-date)'"></span>
                </div>
              </div>
            </div>

            <!-- EVENING -->
            <div>
              <div class="flex items-center gap-3">
                <div class="w-6 flex flex-col items-center shrink-0">
                  <i class="fa-solid fa-moon text-indigo-400 text-sm"></i>
                </div>
                <div class="flex-1 h-1.5 bg-gray-50 rounded-full overflow-hidden">
                  <div
                    class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-1000"
                    :style="'width: ' + (showProfileAnim ? sessionDist.e : 0) + '%'"></div>
                </div>
                <div class="w-16 text-right leading-tight">
                  <span class="text-xs font-bold text-gray-400"
                    x-text="(profile.count_evening || 0) + ' entries'"></span>
                </div>
              </div>
              <div class="flex items-center gap-3 -mt-1">
                <div class="w-6"></div>
                <div class="flex-1 text-right">
                  <span :class="avgEveningSameday.isLate ? 'text-rose-500' : 'text-emerald-500'"
                    class="text-xs font-bold" x-text="'xÌ„ ' + avgEveningSameday.label"></span>
                  <span x-show="eveningOverdueCount > 0" class="text-orange-500 text-xs font-bold ml-2"
                    x-text="'(' + eveningOverdueCount + ' after-date)'"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- HOURLY_DISTRIBUTION_V2 -->
        <div class="glass-card p-3">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-clock text-indigo-500/50"></i>
              <h3 class="text-sm font-bold text-gray-800">24-Hr Submission</h3>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-xs font-bold text-gray-400 uppercase">Peak:</span>
              <span class="text-xs font-bold text-indigo-600"
                x-text="hourlyStats.peakHour >= 0 ? (hourlyStats.peakHour.toString().padStart(2, '0') + ':00') : 'None'"></span>
            </div>
          </div>

          <div class="flex items-stretch justify-between h-[75px] gap-1 px-1">
            <template x-for="(count, hour) in hourlyStats.data" :key="hour">
              <div class="flex-1 flex flex-col items-center group relative h-full">
                <!-- Bar Wrapper -->
                <div class="w-full bg-gray-50 rounded-full overflow-hidden flex items-end h-full">
                  <div
                    class="w-full bg-gradient-to-t from-rose-500 to-pink-400 rounded-full transition-all duration-1000"
                    :style="'height: ' + (showProfileAnim ? (count / hourlyStats.max * 100) : 0) + '%'"
                    :title="hour + ':00 - ' + count + ' cases'">
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- X-Axis Labels -->
          <div class="relative mt-2 px-1">
            <div class="flex items-stretch justify-between">
              <template x-for="(count, hour) in hourlyStats.data" :key="'label-' + hour">
                <div class="flex-1 flex justify-center">
                  <span x-show="[0, 9, 12, 16, 20, 23].includes(parseInt(hour))" class="text-xs font-bold text-gray-400"
                    x-text="hour.toString().padStart(2, '0')"></span>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="py-10 flex flex-col items-center">
          <span class="text-xs font-black text-gray-200 uppercase">DailyStat Dashboard
            V2.0</span>
        </div>
      </div>
      <!-- PRECISION_DASHBOARD_END -->
    </div>
    <!-- PROFILE_VIEW END -->
    <!-- DYNAMIC_VIEWS END -->
  </main>
  <!-- MAIN_CONTENT_CONTAINER END -->

  <!-- BOTTOM_NAVIGATION START -->
  <nav
    class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-gray-100 px-10 safe-area-inset-bottom z-50">
    <div class="container mx-auto max-w-sm flex justify-between">
      <button @click="activeTab = 'dashboard'" class="nav-item" :class="activeTab === 'dashboard' ? 'active' : ''">
        <i class="fa-solid fa-gauge-high text-xl mb-1"></i>
        <span>Dashboard</span>
      </button>
      <button @click="activeTab = 'ranking'" class="nav-item" :class="activeTab === 'ranking' ? 'active' : ''">
        <i class="fa-solid fa-ranking-star text-xl mb-1"></i>
        <span>Ranking</span>
      </button>
      <button @click="activeTab = 'profile'" class="nav-item" :class="activeTab === 'profile' ? 'active' : ''">
        <i class="fa-solid fa-user text-xl mb-1"></i>
        <span>Profile</span>
      </button>
    </div>
  </nav>
  <!-- BOTTOM_NAVIGATION END -->

  <!-- RANKUP_CELEBRATION_MODAL START -->
  <div x-show="showRankup" x-cloak
    class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm"
    x-transition.opacity>
    <div class="glass-card w-full max-w-sm p-8 text-center relative overflow-hidden"
      x-transition:enter="transition ease-out duration-500 scale-90 opacity-0"
      x-transition:enter-start="scale-90 opacity-0" x-transition:enter-end="scale-100 opacity-100">

      <div class="absolute top-0 left-0 w-full h-2 premium-gradient"></div>

      <div class="text-6xl mb-4 animate-bounce"
        x-text="profile.rank_up_msg?.includes('CLASS') ? (rankConfig[profile.current_class]?.emoji || 'ðŸŽŠ') : (profile.rank_up_msg?.includes('TITLE') ? 'ðŸŽ–ï¸' : 'ðŸŽŠ')">
      </div>
      <h2 class="text-2xl font-black text-gray-800 mb-2" x-text="profile.rank_up_msg?.split(':')[0] || 'RANK UP!'"></h2>
      <p class="text-gray-500 text-sm mb-6 font-bold"
        x-text="profile.rank_up_msg?.split(':').slice(1).join(':').trim() || 'Congratulations!'"></p>

      <div
        :class="'inline-flex items-center px-6 py-2 rounded-full text-white font-black shadow-lg mb-8 bg-gradient-to-r ' + (profile.rank_up_msg?.includes('CLASS') ? (rankConfig[profile.current_class]?.color || 'from-blue-600 to-indigo-600') : 'from-yellow-400 to-orange-500')">
        <span
          x-text="profile.rank_up_msg?.includes('CLASS') ? (rankConfig[profile.current_class]?.emoji || 'ðŸ†') : 'âœ¨'"></span>
        <span
          x-text="profile.rank_up_msg?.includes('CLASS') ? profile.current_class : (profile.current_title ? profile.current_title.replace(/^[^a-zA-Z]*/, '') : 'New Title')"
          class="ml-2 uppercase text-lg"></span>
      </div>

      <button @click="closeRankup()"
        class="w-full py-4 premium-gradient text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
        Got it, let's go!
      </button>
    </div>
  </div>
  <!-- RANKUP_CELEBRATION_MODAL END -->

  <!-- REWARD_EXCHANGE_CONFIRM_MODAL START -->
  <div x-show="showSellModal" x-cloak
    class="fixed inset-0 z-[110] flex items-center justify-center p-6 bg-black/40 backdrop-blur-[2px]"
    x-transition.opacity>
    <div class="glass-card w-full max-w-[280px] p-6 text-center shadow-2xl"
      x-transition:enter="transition ease-out duration-300 scale-95 opacity-0"
      x-transition:enter-start="scale-95 opacity-0" x-transition:enter-end="scale-100 opacity-100">

      <div class="text-3xl mb-3" x-text="sellItemTarget?.emoji"></div>
      <h3 class="text-lg font-bold text-gray-800 mb-1">Exchange Reward?</h3>
      <p class="text-gray-500 text-xs mb-6">Exchange <span class="font-bold text-gray-700"
          x-text="sellItemTarget?.displayName"></span><br>for 50-300 EXP?</p>

      <div class="flex gap-3">
        <button @click="showSellModal = false"
          class="flex-1 py-2.5 bg-gray-100 text-gray-500 font-bold rounded-xl text-xs active:scale-95 transition-transform">
          Cancel
        </button>
        <button @click="executeSell()"
          class="flex-1 py-2.5 bg-gradient-to-r from-rose-500 to-pink-500 text-white font-bold rounded-xl text-xs shadow-lg active:scale-95 transition-transform">
          Confirm
        </button>
      </div>
    </div>
  </div>
  <!-- REWARD_EXCHANGE_CONFIRM_MODAL END -->

  <!-- REWARD_EXCHANGE_RESULT_MODAL START -->
  <div x-show="showSellResultModal" x-cloak
    class="fixed inset-0 z-[120] flex items-center justify-center p-6 bg-black/20 backdrop-blur-[1px]"
    x-transition.opacity>
    <div class="glass-card w-full max-w-[240px] p-6 text-center shadow-2xl border-2 border-emerald-100"
      x-transition:enter="transition ease-out duration-500 scale-90 opacity-0"
      x-transition:enter-start="scale-90 opacity-0" x-transition:enter-end="scale-100 opacity-100">

      <div class="text-4xl mb-2 animate-bounce">âœ¨</div>
      <h3 class="text-emerald-600 font-black text-xl mb-1">Success!</h3>
      <p class="text-gray-500 text-xs mb-4">You earned</p>

      <div class="inline-block px-4 py-2 bg-emerald-50 rounded-2xl mb-6">
        <span class="text-2xl font-black text-emerald-600" x-text="'+' + earnedExpResult"></span>
        <span class="text-xs font-bold text-emerald-400 ml-1 uppercase">EXP</span>
      </div>

      <button @click="showSellResultModal = false"
        class="w-full py-3 bg-gray-800 text-white font-bold rounded-xl text-xs active:scale-95 transition-transform">
        Awesome!
      </button>
    </div>
  </div>
  <!-- REWARD_EXCHANGE_RESULT_MODAL END -->

  <!-- LOADING_OVERLAY START -->
  <div x-show="isLoading" x-cloak
    class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center space-y-4">
    <div class="w-16 h-16 relative">
      <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
      <div class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
    </div>
  </div>
  <!-- LOADING_OVERLAY END -->

  <script>
    const WEB_APP_URL = 'https://script.google.com/a/macros/rsu.ac.th/s/AKfycbxWTt29Ry2K8upGAFQV1rnxFnDHB9IUb4ahim3tZXFVvOUZv3jqxrrQnZ61NbTz6CdmHA/exec'; // REPLACE WITH ACTUAL URL

    function dailyApp() {
      return {
        activeTab: 'dashboard',
        selectedReward: null,
        isLoading: true,
        showRankup: false,
        profile: {},
        userId: null,
        system: {},
        leaderboard: [],
        leaderboardLimit: 10,
        allowToggleAllLeaderboard: false,
        showAllLeaderboard: false,
        recentScores: [],
        showExp: false,
        showDeptAnim: false,
        showProfileAnim: false,
        showPersonaTooltip: false,
        showClassTooltip: false,
        showTitleTooltip: false,
        showSellModal: false,
        sellItemTarget: null,
        showSellResultModal: false,
        earnedExpResult: 0,
        activeInfo: null,


        getAccStyles(acc) {
          const v = parseFloat(acc) || 0;
          if (v >= 90) return {
            card: '!bg-emerald-50/50 !border-emerald-100/50',
            text: 'text-emerald-600'
          };
          if (v >= 75) return {
            card: '!bg-blue-50/50 !border-blue-100/50',
            text: 'text-blue-600'
          };
          if (v >= 60) return {
            card: '!bg-amber-50/50 !border-amber-100/50',
            text: 'text-amber-500'
          };
          return {
            card: '!bg-rose-50/50 !border-rose-100/50',
            text: 'text-rose-600'
          };
        },

        formatName(email) {
          if (!email) return '';
          const prefix = email.split('@')[0];
          return prefix.charAt(0).toUpperCase() + prefix.slice(1);
        },

        statusColors: {
          'perfect': 'bg-gradient-to-r from-cyan-500 to-blue-500',
          'good': 'bg-gradient-to-r from-emerald-500 to-teal-500',
          'fair': 'bg-gradient-to-r from-amber-500 to-orange-500',
          'overdue': 'bg-gradient-to-r from-rose-500 to-pink-500',
          'error': 'bg-gray-400'
        },

        rankConfig: {
          'Diamond': { emoji: 'ðŸ’Ž', color: 'from-cyan-400 to-blue-500' },
          'Platinum': { emoji: 'â—»ï¸', color: 'from-emerald-400 to-teal-500' },
          'Gold': { emoji: 'ðŸ¥‡', color: 'from-yellow-400 to-orange-500' },
          'Silver': { emoji: 'ðŸ¥ˆ', color: 'from-slate-300 to-slate-400' },
          'Bronze': { emoji: 'ðŸ¥‰', color: 'from-orange-700 to-amber-900' },
          'Beginner': { emoji: 'â–«ï¸', color: 'from-gray-400 to-gray-500' }
        },

        deptIconMap: {
          'Endo': '<i class="fa-solid fa-thumbtack"></i>',
          'Oper': '<i class="fa-solid fa-tooth"></i>',
          'Diag': '<i class="fa-solid fa-magnifying-glass"></i>',
          'Ortho': '<i class="fa-solid fa-face-grimace"></i>',
          'Pedo': '<i class="fa-solid fa-children"></i>',
          'Perio': '<i class="fa-solid fa-teeth"></i>',
          'Prosth': '<i class="fa-solid fa-teeth-open"></i>',
          'Radio': '<i class="fa-solid fa-skull"></i>',
          'Surg': '<i class="fa-solid fa-head-side-mask"></i>'
        },

        get allSortedLeaderboard() {
          return [...this.leaderboard].sort((a, b) => {
            // 1. Recent Accuracy (Last 20 cases)
            if (b.recent_acc !== a.recent_acc) return (b.recent_acc || 0) - (a.recent_acc || 0);
            // 2. All-time Accuracy (Tie-breaker)
            if (b.alltime_acc !== a.alltime_acc) return (b.alltime_acc || 0) - (a.alltime_acc || 0);
            // 3. Alphabetical (Ultimate tie-breaker)
            return (a.display_name || '').localeCompare(b.display_name || '');
          });
        },

        get myRank() {
          const email = this.profile.email;

          // 1. Check if in 100% Club
          if ((this.profile.recent_acc || 0) >= 100) return 1;

          // 2. Check if in Challengers
          const challengers = this.challengerMembers; // This now has .rank computed
          const me = challengers.find(u => u.email === email);
          return me ? me.rank : '-';
        },

        get clubMembers() {
          // 100% Club: Recent Acc == 100, Sorted Alphabetically
          return this.leaderboard
            .filter(u => (u.recent_acc || 0) >= 100)
            .sort((a, b) => (a.display_name || '').localeCompare(b.display_name || ''));
        },

        get challengerMembers() {
          // Challengers: Recent Acc < 100
          // Sorting: Recent -> Alltime -> Alpha
          const list = this.leaderboard
            .filter(u => (u.recent_acc || 0) < 100)
            .sort((a, b) => {
              if ((b.recent_acc || 0) !== (a.recent_acc || 0)) return (b.recent_acc || 0) - (a.recent_acc || 0);
              if ((b.alltime_acc || 0) !== (a.alltime_acc || 0)) return (b.alltime_acc || 0) - (a.alltime_acc || 0);
              return (a.display_name || '').localeCompare(b.display_name || '');
            });

          // Calculate Dense Ranking (Start at 2)
          let currentRank = 2;
          let prevUser = null;

          const rankedList = list.map((u, idx) => {
            if (idx > 0) {
              // If scores are DIFFERENT from previous, increment rank
              // Scores = Recent Acc & All-time Acc (ignore alpha)
              const prev = list[idx - 1];
              const isDifferent = (u.recent_acc !== prev.recent_acc) || (u.alltime_acc !== prev.alltime_acc);
              if (isDifferent) {
                currentRank++;
              }
            }
            // Return new object with rank
            return { ...u, rank: currentRank };
          });

          if (this.showAllLeaderboard) return rankedList;
          return rankedList.slice(0, this.leaderboardLimit);
        },

        get orderedDeptStats() {
          const order = ['Perio', 'Oper', 'Endo', 'Prosth', 'Diag', 'Pedo', 'Radio', 'Ortho', 'Surg'];
          const stats = this.system.dept_stats || {};
          return order.map(name => ({
            name,
            accuracy: stats[name]?.accuracy || 0
          }));
        },

        get expPercentage() {
          if (!this.profile.total_exp || !this.profile.next_rank_exp) return 0;
          const current = this.profile.total_exp;
          const next = this.profile.next_rank_exp;
          if (next <= current) return 100;
          return Math.min(100, Math.round((current / next) * 100));
        },


        get groupedRewards() {
          const rewards = this.profile.rewards || [];
          const counts = {};
          rewards.forEach(r => {
            counts[r] = (counts[r] || 0) + 1;
          });
          return Object.keys(counts).map(key => ({
            fullName: key,
            count: counts[key],
            emoji: key.split(' ')[0],
            displayName: key.split(' ').slice(1).join(' ')
          }));
        },

        get trendPath() {
          const history = this.profile.daily_history || [];
          if (history.length < 2) return '';

          const width = 100;
          const height = 40; // SVG height
          const step = width / (history.length - 1);

          // à¸„à¸³à¸™à¸§à¸“à¸ˆà¸¸à¸”à¹à¸£à¸
          let prevX = 0;
          let prevY = height - (history[0].a / 100 * height);

          let path = `M ${prevX},${prevY}`;

          // à¸§à¸™à¸¥à¸¹à¸›à¸ˆà¸¸à¸”à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­ à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸ªà¹‰à¸™à¹‚à¸„à¹‰à¸‡
          for (let i = 1; i < history.length; i++) {
            const currentX = i * step;
            const currentY = height - (history[i].a / 100 * height);

            // à¹€à¸—à¸„à¸™à¸´à¸„: à¸ªà¸£à¹‰à¸²à¸‡ Control Point à¸—à¸µà¹ˆà¸à¸¶à¹ˆà¸‡à¸à¸¥à¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ 2 à¸ˆà¸¸à¸”
            // cp1X = à¸”à¸¶à¸‡à¸­à¸­à¸à¸ˆà¸²à¸à¸ˆà¸¸à¸”à¹€à¸”à¸´à¸¡à¹„à¸›à¸—à¸²à¸‡à¸‚à¸§à¸²à¸„à¸£à¸¶à¹ˆà¸‡à¸—à¸²à¸‡
            // cp2X = à¸”à¸¶à¸‡à¸­à¸­à¸à¸ˆà¸²à¸à¸ˆà¸¸à¸”à¹ƒà¸«à¸¡à¹ˆà¹„à¸›à¸—à¸²à¸‡à¸‹à¹‰à¸²à¸¢à¸„à¸£à¸¶à¹ˆà¸‡à¸—à¸²à¸‡
            const cp1X = prevX + (currentX - prevX) / 2;
            const cp1Y = prevY; // à¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡à¹€à¸—à¹ˆà¸²à¸ˆà¸¸à¸”à¹€à¸”à¸´à¸¡

            const cp2X = prevX + (currentX - prevX) / 2;
            const cp2Y = currentY; // à¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡à¹€à¸—à¹ˆà¸²à¸ˆà¸¸à¸”à¹ƒà¸«à¸¡à¹ˆ

            // C = Cubic Bezier Curve
            path += ` C ${cp1X},${cp1Y} ${cp2X},${cp2Y} ${currentX},${currentY}`;

            // à¸­à¸±à¸›à¹€à¸”à¸•à¸ˆà¸¸à¸”à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¹ƒà¸™à¸£à¸­à¸šà¸–à¸±à¸”à¹„à¸›
            prevX = currentX;
            prevY = currentY;
          }

          return path;
        },

        get trendFill() {
          const path = this.trendPath;
          if (!path) return '';
          return `${path} L 100,40 L 0,40 Z`;
        },

        get trendDirection() {
          const history = this.profile.daily_history || [];
          if (history.length < 2) return 'none';
          const last = history[history.length - 1].a;
          const prev = history[history.length - 2].a;
          if (last > prev) return 'up';
          if (last < prev) return 'down';
          return 'none';
        },

        formatDelta(minutes) {
          const abs = Math.abs(Math.round(minutes));
          if (abs < 60) return abs + 'm';
          const h = Math.floor(abs / 60);
          const m = abs % 60;
          return h + 'h ' + m + 'm';
        },

        get avgMorning() {
          const count = this.profile.count_morning || 0;
          const deltaSum = this.profile.total_morning_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get avgAfternoon() {
          const count = this.profile.count_afternoon || 0;
          const deltaSum = this.profile.total_afternoon_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get avgEvening() {
          const count = this.profile.count_evening || 0;
          const deltaSum = this.profile.total_evening_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get onTimePercent() {
          const total = this.profile.total_cases_count || 0;
          if (total === 0) return 0;
          return Math.round((this.profile.total_on_time || 0) / total * 100);
        },

        get overduePercent() {
          const total = this.profile.total_cases_count || 0;
          if (total === 0) return 0;
          return Math.round((this.profile.total_overdue || 0) / total * 100);
        },

        get tooEarlyPercent() {
          const total = this.profile.total_cases_count || 0;
          if (total === 0) return 0;
          return Math.round((this.profile.total_too_early || 0) / total * 100);
        },

        get avgDelta() {
          // Use same-day count only (excluding overdue)
          const count = this.profile.count_sameday || 0;
          if (count <= 0) return 0;
          return this.profile.total_sameday_delta / count;
        },

        get sdDelta() {
          const count = this.profile.count_sameday || 0;
          if (count <= 1) return 0;
          const avg = this.avgDelta;
          const meanSq = this.profile.total_sameday_delta_sq / count;
          const variance = meanSq - (avg * avg);
          return Math.sqrt(Math.max(0, variance));
        },

        get morningAvgDelta() {
          const count = this.profile.count_morning || 0;
          if (count === 0) return 0;
          return this.profile.total_morning_delta / count;
        },

        get hourlyStats() {
          let raw = [];
          try {
            const field = this.profile.hourly_dist_json;
            raw = typeof field === 'string' ? JSON.parse(field || '[]') : (field || []);
          } catch (e) {
            console.error('Error parsing hourly_dist_json', e);
            raw = [];
          }
          // Ensure it's an array of length 24 and all values are numbers
          const data = (Array.isArray(raw) && raw.length === 24)
            ? raw.map(v => Number(v) || 0)
            : new Array(24).fill(0);

          const maxVal = Math.max(...data);
          const max = maxVal > 0 ? maxVal : 1;
          const peakHour = maxVal > 0 ? data.indexOf(maxVal) : -1;
          return { data, max, peakHour };
        },

        // Overdue count computed properties
        get morningOverdueCount() {
          return (this.profile.count_morning || 0) - (this.profile.count_morning_sameday || 0);
        },

        get afternoonOverdueCount() {
          return (this.profile.count_afternoon || 0) - (this.profile.count_afternoon_sameday || 0);
        },

        get eveningOverdueCount() {
          return (this.profile.count_evening || 0) - (this.profile.count_evening_sameday || 0);
        },

        // Same-day session averages
        get avgMorningSameday() {
          const count = this.profile.count_morning_sameday || 0;
          const deltaSum = this.profile.total_morning_sameday_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get avgAfternoonSameday() {
          const count = this.profile.count_afternoon_sameday || 0;
          const deltaSum = this.profile.total_afternoon_sameday_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get avgEveningSameday() {
          const count = this.profile.count_evening_sameday || 0;
          const deltaSum = this.profile.total_evening_sameday_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        formatOverdueDelay(minutes) {
          if (!minutes || minutes <= 0) return '0 mins';

          const totalMinutes = Math.round(minutes);

          // If less than 1 hour, show minutes only
          if (totalMinutes < 60) {
            return `${totalMinutes} mins`;
          }

          // If less than 1 day, show hours and minutes
          if (totalMinutes < 1440) { // 1440 = 24 hours
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
          }

          // If 1 day or more, show days, hours, and minutes
          const days = Math.floor(totalMinutes / 1440);
          const remainingMins = totalMinutes % 1440;
          const hours = Math.floor(remainingMins / 60);
          const mins = remainingMins % 60;

          let result = `${days}d`;
          if (hours > 0) result += ` ${hours}h`;
          if (mins > 0) result += ` ${mins}m`;

          return result;
        },

        get classDisplay() {
          const c = (this.profile.current_class || 'Beginner');
          const emojis = { 'Diamond': 'ðŸ’Ž', 'Platinum': 'â—»ï¸', 'Gold': 'ðŸ¥‡', 'Silver': 'ðŸ¥ˆ', 'Bronze': 'ðŸ¥‰', 'Beginner': 'â–«ï¸' };
          return (emojis[c] || '') + c + ' Class';
        },

        get sessionDist() {
          const total = this.profile.total_cases_count || 0;
          if (total === 0) return { m: 0, a: 0, e: 0 };
          return {
            m: Math.round((this.profile.count_morning || 0) / total * 100),
            a: Math.round((this.profile.count_afternoon || 0) / total * 100),
            e: Math.round((this.profile.count_evening || 0) / total * 100)
          };
        },

        get personaConfig() {
          const avg = this.avgDelta;
          if (avg <= 0) return { name: 'The Flash', emoji: 'âš¡', desc: 'Lightning fast! You always finish your work on or before the target time.' };
          if (avg <= 60) return { name: 'The Slow-burner', emoji: 'ðŸ§˜', desc: 'Slow but steady. You might be a bit after the target, but you always arrive within the hour!' };
          return { name: 'The Deadline Diver', emoji: 'ðŸ¤¿', desc: 'Better late than never! You usually pass the 60-minute mark, but hey, you got it done!' };
        },

        get classProgression() {
          // Based on CONFIG.CLASS_RANK.TIERS from Config.gs
          const classes = [
            { name: 'Diamond', emoji: 'ðŸ’Ž', minPrecision: 95, maxPrecision: 100, order: 1 },
            { name: 'Platinum', emoji: 'â—»ï¸', minPrecision: 85, maxPrecision: 94, order: 2 },
            { name: 'Gold', emoji: 'ðŸ¥‡', minPrecision: 70, maxPrecision: 84, order: 3 },
            { name: 'Silver', emoji: 'ðŸ¥ˆ', minPrecision: 50, maxPrecision: 69, order: 4 },
            { name: 'Bronze', emoji: 'ðŸ¥‰', minPrecision: 0, maxPrecision: 49, order: 5 },
            { name: 'Beginner', emoji: 'â–«ï¸', minPrecision: null, maxPrecision: null, order: 6 }
          ];

          return classes.map(cls => ({
            ...cls,
            isCurrent: cls.name === this.profile.current_class
          }));
        },

        get titleProgression() {
          // Title configuration based on Config.gs EXP_RANK.PHASES
          const phases = [
            {
              name: 'Legendary',
              emoji: 'ðŸ‘‘',
              min: 15001,
              max: Infinity,
              tiers: []
            },
            {
              name: 'Grand Master',
              emoji: 'âšœï¸',
              min: 9001,
              max: 15000,
              tiers: []
            },
            {
              name: 'Master',
              emoji: 'ðŸ’ ',
              min: 4501,
              max: 9000,
              tiers: [
                { tier: 'Tier â… ', min: 7501, max: 9000, icon: 'ðŸŒŸ' },
                { tier: 'Tier â…¡', min: 6001, max: 7500, icon: 'â­ï¸' },
                { tier: 'Tier â…¢', min: 4501, max: 6000, icon: '' }
              ]
            },
            {
              name: 'Senior',
              emoji: 'ðŸŽ–ï¸',
              min: 1501,
              max: 4500,
              tiers: [
                { tier: 'Tier â… ', min: 3501, max: 4500, icon: 'ðŸŒŸ' },
                { tier: 'Tier â…¡', min: 2501, max: 3500, icon: 'â­ï¸' },
                { tier: 'Tier â…¢', min: 1501, max: 2500, icon: '' }
              ]
            },
            {
              name: 'Rookie',
              emoji: 'ðŸ”°',
              min: 0,
              max: 1500,
              tiers: [
                { tier: 'Tier â… ', min: 1001, max: 1500, icon: 'ðŸŒŸ' },
                { tier: 'Tier â…¡', min: 501, max: 1000, icon: 'â­ï¸' },
                { tier: 'Tier â…¢', min: 0, max: 500, icon: '' }
              ]
            }
          ];

          const currentExp = this.profile.total_exp || 0;
          const currentTitle = this.profile.current_title || '';

          return phases.map((phase, idx) => {
            const isCurrentPhase = currentTitle.includes(phase.name);
            let currentTier = null;

            if (phase.tiers && phase.tiers.length > 0) {
              currentTier = phase.tiers.find(t => currentExp >= t.min && currentExp <= t.max);
            }

            return {
              order: idx + 1,
              name: phase.name,
              emoji: phase.emoji,
              min: phase.min,
              max: phase.max === Infinity ? null : phase.max,
              tiers: phase.tiers || [],
              isCurrentPhase,
              currentTier: isCurrentPhase ? currentTier : null
            };
          });
        },

        triggerTabAnimations(tab) {
          if (tab === 'dashboard') {
            if (this.showExp) this.showExp = false;
            this.$nextTick(() => {
              setTimeout(() => {
                this.showExp = true;
              }, 50);
            });
          } else if (tab === 'ranking') {
            if (this.showDeptAnim) this.showDeptAnim = false;
            this.$nextTick(() => {
              setTimeout(() => this.showDeptAnim = true, 50);
            });
          } else if (tab === 'profile') {
            if (this.showProfileAnim) this.showProfileAnim = false;
            this.$nextTick(() => {
              setTimeout(() => this.showProfileAnim = true, 50);
            });
          }
        },

        async init() {
          try {
            await liff.init({ liffId: '2008789653-GNraHzM6' });
            if (!liff.isLoggedIn()) {
              liff.login();
              return;
            }

            const idToken = liff.getDecodedIDToken();
            let email = idToken ? idToken.email : null;
            let userId = null;
            let pictureUrl = idToken ? idToken.picture : null;

            if (!email || !pictureUrl) {
              const liffProfile = await liff.getProfile();
              userId = liffProfile.userId;
              pictureUrl = liffProfile.pictureUrl;
            }

            console.log('Auth Identifier:', email || userId);
            await this.fetchData(email || undefined, userId || undefined, pictureUrl);

            this.isLoading = false;

            // Check for rank up celebration
            if (this.profile.is_rank_up) {
              setTimeout(() => this.showRankup = true, 500);
            }

            this.$nextTick(() => {
              // Watch for tab changes to reset animations
              this.$watch('activeTab', (value) => {
                this.triggerTabAnimations(value);
              });

              // Trigger initial animations for default tab
              this.triggerTabAnimations(this.activeTab);
            });

          } catch (err) {
            console.error('Initialization failed', err);
            alert('Initialization Error: ' + err.message);
            this.isLoading = false;
          }
        },

        async fetchData(email, userId, pictureUrl) {
          try {
            const [profileRes, leaderboardRes] = await Promise.all([
              this.callAPI('getProfile', { email, userId }),
              this.callAPI('getLeaderboard')
            ]);

            console.log('Profile Response:', profileRes);

            if (profileRes.success) {
              const profile = profileRes.profile;
              // Consolidate data into a single reactive update
              if (pictureUrl) profile.pictureUrl = pictureUrl;
              if (userId && !profile.userId) profile.userId = userId;

              this.profile = profile;
              this.recentScores = JSON.parse(this.profile.recent_scores_json || '[]');
              this.system = profileRes.system; // Use system data from profile response
              if (leaderboardRes.success) {
                this.leaderboard = leaderboardRes.leaderboard;
              }
            } else {
              console.warn('Profile fetch failed:', profileRes);
              alert('à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ: ' + (profileRes.message || 'Unknown error'));
            }
          } catch (err) {
            console.error('Fetch data failed', err);
          }
        },

        async callAPI(action, params = {}) {
          try {
            // Use userId from state if not provided and profile not yet set
            const activeUserId = params.userId || this.userId || (this.profile && this.profile.userId);
            if (activeUserId && !params.userId) {
              params.userId = activeUserId;
            }

            const query = new URLSearchParams({ action, ...params }).toString();
            const response = await fetch(`${WEB_APP_URL}?${query}`);
            return await response.json();
          } catch (err) {
            console.error(`API Call failed: ${action}`, err);
            return { success: false, message: err.message };
          }
        },


        formatThaiDate(dateStr) {
          if (!dateStr) return '---';
          const date = new Date(dateStr);
          const day = date.getDate();
          const monthNames = ['à¸¡.à¸„.', 'à¸.à¸ž.', 'à¸¡à¸µ.à¸„.', 'à¹€à¸¡.à¸¢.', 'à¸ž.à¸„.', 'à¸¡à¸´.à¸¢.', 'à¸.à¸„.', 'à¸ª.à¸„.', 'à¸.à¸¢.', 'à¸•.à¸„.', 'à¸ž.à¸¢.', 'à¸˜.à¸„.'];
          const month = monthNames[date.getMonth()];
          const thaiYear = ((date.getFullYear() + 543) % 100).toString().padStart(2, '0');
          return `${day} ${month} ${thaiYear}`;
        },

        async closeRankup() {
          this.showRankup = false;
          await this.callAPI('clearRankUp', { email: this.profile.email });
        },

        async sellReward(reward) {
          // Open custom confirm modal instead of browser confirm
          this.sellItemTarget = reward;
          this.showSellModal = true;
          this.selectedReward = null;
        },

        async executeSell() {
          if (!this.sellItemTarget) return;

          const reward = this.sellItemTarget;
          this.showSellModal = false;
          this.isLoading = true;

          try {
            const res = await this.callAPI('exchangeReward', {
              email: this.profile.email,
              rewardName: reward.fullName
            });

            if (res.success) {
              this.earnedExpResult = res.earned_exp;

              // Refresh profile data
              await this.fetchData(this.profile.email, this.userId, this.profile.pictureUrl);

              // Show success modal
              this.showSellResultModal = true;

              if (res.rank_changed) {
                // Wait a bit before showing rank up if needed
                setTimeout(() => {
                  if (!this.showSellResultModal) this.showRankup = true;
                  else {
                    // Watch for result modal close to show rankup
                    const unwatch = this.$watch('showSellResultModal', (val) => {
                      if (!val) {
                        this.showRankup = true;
                        unwatch();
                      }
                    });
                  }
                }, 500);
              }
            } else {
              alert('Error: ' + res.message);
            }
          } catch (err) {
            console.error('Exchange failed', err);
            alert('Connection error, please try again.');
          } finally {
            this.isLoading = false;
            this.sellItemTarget = null;
          }
        },


      }
    }
  </script>
</body>

</html>