<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Stat - RSU Dental</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rsu: {
                            blue: '#1e40af',
                            light: '#dbeafe',
                            dark: '#1e3a8a'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer components {
            .glass-card {
                @apply bg-white/90 backdrop-blur-md border border-white/20 shadow-xl rounded-2xl;
            }
            .nav-item {
                @apply flex flex-col items-center justify-center pt-2 pb-1 text-xs font-medium transition-colors duration-200;
            }
            .nav-item.active {
                @apply text-blue-600;
            }
            .nav-item:not(.active) {
                @apply text-gray-400 hover:text-gray-600;
            }
            .stat-value {
                @apply text-2xl font-bold tracking-tight text-gray-900;
            }
            .stat-label {
                @apply text-[10px] uppercase tracking-wider font-bold text-gray-400;
            }
            .rank-badge {
                @apply px-3 py-1 rounded-full text-[10px] font-bold text-white shadow-sm;
            }
            /* Custom Gradients from DailyRemover */
            .premium-gradient {
                @apply bg-gradient-to-br from-blue-600 via-indigo-600 to-violet-700;
            }
            .ticker-wrap {
                @apply w-full overflow-hidden bg-gray-900/5 py-2;
            }
            .ticker-move {
                display: inline-block;
                white-space: nowrap;
                padding-right: 100%;
                animation: ticker 30s linear infinite;
            }
            @keyframes ticker {
                0% { transform: translate3d(0, 0, 0); }
                100% { transform: translate3d(-100%, 0, 0); }
            }
            [x-cloak] { display: none !important; }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-900 font-sans pb-24" x-data="dailyApp()" x-init="init()">

    <!-- Top Header -->
    <header class="premium-gradient text-white px-6 pt-8 pb-16 rounded-b-[3rem] shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 left-0 -ml-10 -mb-10 w-48 h-48 bg-blue-400/20 rounded-full blur-2xl"></div>

        <div class="relative z-10 flex justify-between items-start">
            <div>
                <h1 class="text-xs font-bold uppercase tracking-[0.2em] opacity-80 mb-1">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h1>
                <div class="flex items-center gap-2">
                    <span class="text-2xl font-black" x-text="profile.display_name || 'Loading...'"></span>
                    <i class="fa-solid fa-circle-check text-blue-300 text-sm"></i>
                </div>
                <p class="text-[10px] opacity-70 mt-1 font-medium" x-text="profile.email"></p>
            </div>
            <div class="text-right">
                <div :class="'rank-badge ' + (rankConfig[profile.current_class]?.color || 'from-gray-400 to-gray-500')">
                    <span x-text="rankConfig[profile.current_class]?.emoji || '‚ö™'"></span>
                    <span x-text="profile.current_class || 'UNRANKED'" class="ml-1"></span>
                </div>
                <div class="mt-2 text-[10px] font-bold opacity-80" x-text="profile.current_title || 'Novice'"></div>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="px-5 -mt-8 relative z-20 space-y-4">

        <!-- Dashboard Stats Row -->
        <div class="grid grid-cols-3 gap-3">
            <div class="glass-card p-3 flex flex-col items-center">
                <div class="stat-label">Total MP</div>
                <div class="stat-value text-blue-600" x-text="profile.total_mp?.toLocaleString() || '0'"></div>
            </div>
            <div class="glass-card p-3 flex flex-col items-center">
                <div class="stat-label">Accuracy</div>
                <div class="stat-value text-emerald-600" x-text="(profile.recent_acc || 0) + '%'"></div>
            </div>
            <div class="glass-card p-3 flex flex-col items-center">
                <div class="stat-label">Streak</div>
                <div class="stat-value text-orange-500">
                    <span x-text="profile.current_streak || 0"></span>
                    <i class="fa-solid fa-fire text-sm ml-0.5"></i>
                </div>
            </div>
        </div>

        <!-- Ticker Messages -->
        <div class="ticker-wrap rounded-xl" x-show="system.ticker_messages?.length > 0">
            <div class="ticker-move text-[11px] font-bold text-blue-900/60 uppercase tracking-wider">
                <template x-for="msg in system.ticker_messages" :key="msg">
                    <span class="mx-8 flex-inline items-center">
                        <i class="fa-solid fa-bullhorn mr-2"></i>
                        <span x-text="msg"></span>
                    </span>
                </template>
            </div>
        </div>

        <!-- Dynamic Views -->
        <div x-cloak>

            <!-- Dashboard View -->
            <div x-show="activeTab === 'dashboard'" class="space-y-4">

                <!-- Experience Progress -->
                <div class="glass-card p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold uppercase text-gray-400">Experience Rank</span>
                        <span class="text-xs font-bold text-gray-700" x-text="profile.current_title"></span>
                    </div>
                    <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden mb-2">
                        <div class="h-full premium-gradient transition-all duration-1000"
                            :style="'width: ' + expPercentage + '%'"></div>
                    </div>
                    <div class="flex justify-between text-[9px] font-bold text-gray-400">
                        <span x-text="profile.total_mp?.toLocaleString() + ' MP'"></span>
                        <span x-text="'Next: ' + (profile.next_rank_mp?.toLocaleString() || 'MAX')"></span>
                    </div>
                </div>

                <!-- Department Comparison Chart -->
                <div class="glass-card p-4">
                    <h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-column text-blue-600"></i>
                        Department Performance (On-time Rate)
                    </h3>
                    <div class="h-48 relative">
                        <canvas id="deptChart"></canvas>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-4 text-center italic">
                        * Average same-day submission percentage per instructor within department
                    </p>
                </div>

                <!-- Recent Activity (Minified) -->
                <div class="glass-card p-4 overflow-hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-gray-800">Recent Accuracy Score</h3>
                        <span class="text-[10px] font-bold text-gray-400 uppercase">Last 20 Cases</span>
                    </div>
                    <div class="flex gap-1 h-12 items-end">
                        <template x-for="(score, idx) in recentScores" :key="idx">
                            <div class="flex-1 rounded-t-sm"
                                :class="score >= 95 ? 'bg-emerald-400' : (score >= 70 ? 'bg-amber-400' : 'bg-rose-400')"
                                :style="'height: ' + Math.max(10, score) + '%'" :title="score + '%'"></div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Leaderboard View -->
            <div x-show="activeTab === 'ranking'" class="space-y-3">
                <div class="flex justify-between items-end px-1">
                    <h2 class="text-xl font-black text-slate-800">Leaderboard</h2>
                    <span class="text-[10px] font-bold text-gray-400 uppercase mb-1">Top 20 Instructors</span>
                </div>

                <div class="glass-card overflow-hidden">
                    <template x-for="(user, idx) in leaderboard" :key="user.email">
                        <div class="flex items-center gap-3 p-3 border-b border-gray-100 last:border-0"
                            :class="user.email === profile.email ? 'bg-blue-50/50' : ''">
                            <div class="w-8 h-8 flex items-center justify-center font-black text-sm rounded-lg"
                                :class="idx === 0 ? 'bg-yellow-100 text-yellow-700' : (idx === 1 ? 'bg-slate-100 text-slate-500' : (idx === 2 ? 'bg-orange-100 text-orange-700' : 'text-gray-400'))">
                                <span x-show="idx > 2" x-text="idx + 1"></span>
                                <i x-show="idx === 0" class="fa-solid fa-crown"></i>
                                <span x-show="idx === 1 || idx === 2" x-text="idx + 1"></span>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-bold text-gray-800" x-text="user.display_name"></div>
                                <div class="text-[10px] text-gray-400 font-bold uppercase" x-text="user.current_title">
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-black text-blue-600" x-text="user.total_mp.toLocaleString()">
                                </div>
                                <div class="text-[9px] font-bold text-gray-300 uppercase">MP Points</div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- History View -->
            <div x-show="activeTab === 'history'" class="space-y-4">
                <div class="flex justify-between items-center px-1">
                    <h2 class="text-xl font-black text-slate-800">History</h2>
                    <span class="text-[10px] font-bold text-gray-400 uppercase"
                        x-text="'Total ' + (historyTotal || 0) + ' items'"></span>
                </div>

                <div class="space-y-6">
                    <template x-for="group in groupedHistory" :key="group.date">
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 px-1">
                                <div class="h-px flex-1 bg-gray-200"></div>
                                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest"
                                    x-text="formatThaiDate(group.date)"></span>
                                <div class="h-px flex-1 bg-gray-200"></div>
                            </div>

                            <div class="space-y-2">
                                <template x-for="item in group.items" :key="item.time + item.student">
                                    <div
                                        class="glass-card p-3 flex justify-between items-center transition-transform active:scale-[0.98]">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-10 h-10 rounded-xl bg-slate-50 flex flex-col items-center justify-center border border-white">
                                                <span class="text-[9px] font-black text-gray-400"
                                                    x-text="item.time"></span>
                                                <i class="fa-solid fa-file-signature text-blue-500/50 text-xs"></i>
                                            </div>
                                            <div>
                                                <div class="text-xs font-bold text-gray-800" x-text="item.student">
                                                </div>
                                                <div class="text-[9px] text-gray-400 font-medium"
                                                    x-text="item.session || 'Period'"></div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div
                                                :class="'px-2 py-0.5 rounded-lg text-[9px] font-black uppercase text-white shadow-sm inline-block ' + statusColors[item.status]">
                                                <span x-text="item.status"></span>
                                            </div>
                                            <div class="text-[9px] font-bold text-gray-300 mt-1"
                                                x-text="'+' + item.score + ' MP'"></div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <div x-show="historyHasMore" class="pt-4 pb-8">
                    <button @click="loadMoreHistory()" :disabled="isLoadingHistory"
                        class="w-full py-3 glass-card text-xs font-bold text-blue-600 hover:bg-blue-50 transition-colors flex items-center justify-center gap-2">
                        <span x-show="!isLoadingHistory">‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                        <i x-show="!isLoadingHistory" class="fa-solid fa-chevron-down"></i>
                        <i x-show="isLoadingHistory" class="fa-solid fa-circle-notch fa-spin"></i>
                    </button>
                </div>

                <div x-show="!isLoading && history.length === 0" class="text-center py-20 text-gray-300">
                    <i class="fa-solid fa-folder-open block text-4xl mb-2 opacity-10"></i>
                    <p class="text-xs italic font-medium">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
                </div>
            </div>

            <!-- Profile / Rewards View -->
            <div x-show="activeTab === 'profile'" class="space-y-4">
                <div class="glass-card p-6 flex flex-col items-center">
                    <div
                        class="w-20 h-20 rounded-full premium-gradient flex items-center justify-center text-3xl text-white shadow-xl mb-4 border-4 border-white">
                        <span x-text="profile.display_name?.charAt(0) || '?'"></span>
                    </div>
                    <h2 class="text-lg font-bold text-gray-800" x-text="profile.display_name"></h2>
                    <p class="text-xs text-gray-400 font-medium" x-text="profile.department || 'No Department'"></p>
                </div>

                <div class="glass-card p-4">
                    <h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-gift text-rose-500"></i>
                        Reward Box
                    </h3>
                    <div class="grid grid-cols-4 gap-2">
                        <template x-for="reward in profile.rewards || []" :key="reward">
                            <div
                                class="aspect-square bg-slate-50 rounded-xl flex items-center justify-center text-xl shadow-inner border border-white">
                                <span x-text="reward.split(' ')[0]"></span>
                            </div>
                        </template>
                        <div x-show="!profile.rewards?.length"
                            class="col-span-4 py-8 text-center text-gray-300 text-xs italic">
                            No rewards yet. Keep it up!
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav
        class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-gray-100 px-6 safe-area-inset-bottom z-50">
        <div class="container mx-auto max-w-md flex justify-between">
            <button @click="activeTab = 'dashboard'" class="nav-item"
                :class="activeTab === 'dashboard' ? 'active' : ''">
                <i class="fa-solid fa-house-chimney text-xl mb-1"></i>
                <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                <div x-show="activeTab === 'dashboard'" class="w-1 h-1 rounded-full bg-blue-600 mt-1"></div>
            </button>
            <button @click="activeTab = 'ranking'" class="nav-item" :class="activeTab === 'ranking' ? 'active' : ''">
                <i class="fa-solid fa-ranking-star text-xl mb-1"></i>
                <span>‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</span>
                <div x-show="activeTab === 'ranking'" class="w-1 h-1 rounded-full bg-blue-600 mt-1"></div>
            </button>
            <button @click="activeTab = 'history'" class="nav-item" :class="activeTab === 'history' ? 'active' : ''">
                <i class="fa-solid fa-history text-xl mb-1"></i>
                <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
                <div x-show="activeTab === 'history'" class="w-1 h-1 rounded-full bg-blue-600 mt-1"></div>
            </button>
            <button @click="activeTab = 'profile'" class="nav-item" :class="activeTab === 'profile' ? 'active' : ''">
                <i class="fa-solid fa-user-gear text-xl mb-1"></i>
                <span>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
                <div x-show="activeTab === 'profile'" class="w-1 h-1 rounded-full bg-blue-600 mt-1"></div>
            </button>
        </div>
    </nav>

    <!-- Rankup Celebration Modal -->
    <div x-show="showRankup" x-cloak
        class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm"
        x-transition.opacity>
        <div class="glass-card w-full max-w-sm p-8 text-center relative overflow-hidden"
            x-transition:enter="transition ease-out duration-500 scale-90 opacity-0"
            x-transition:enter-start="scale-90 opacity-0" x-transition:enter-end="scale-100 opacity-100">

            <div class="absolute top-0 left-0 w-full h-2 premium-gradient"></div>

            <div class="text-6xl mb-4 animate-bounce">üéä</div>
            <h2 class="text-2xl font-black text-gray-800 mb-2" x-text="'RANK UP: ' + profile.current_class"></h2>
            <p class="text-gray-500 text-sm mb-6">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô</p>

            <div
                :class="'inline-flex items-center px-6 py-2 rounded-full text-white font-black shadow-lg mb-8 bg-gradient-to-r ' + (rankConfig[profile.current_class]?.color || 'from-blue-600 to-indigo-600')">
                <span x-text="rankConfig[profile.current_class]?.emoji || 'üèÜ'"></span>
                <span x-text="profile.current_class" class="ml-2 uppercase tracking-widest text-lg"></span>
            </div>

            <button @click="closeRankup()"
                class="w-full py-4 premium-gradient text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö ‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏ï‡πà‡∏≠!
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div x-show="isLoading" x-cloak
        class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center space-y-4">
        <div class="w-16 h-16 relative">
            <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
        </div>
        <div class="text-sm font-bold text-gray-400 tracking-widest uppercase">NongDaily Stat</div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/a/macros/rsu.ac.th/s/AKfycbxWTt29Ry2K8upGAFQV1rnxFnDHB9IUb4ahim3tZXFVvOUZv3jqxrrQnZ61NbTz6CdmHA/exec'; // REPLACE WITH ACTUAL URL

        function dailyApp() {
            return {
                activeTab: 'dashboard',
                isLoading: true,
                showRankup: false,
                profile: {},
                system: {},
                leaderboard: [],
                recentScores: [],
                deptChart: null,

                // History state
                history: [],
                historyPage: 1,
                historyTotal: 0,
                historyHasMore: false,
                isLoadingHistory: false,

                statusColors: {
                    'perfect': 'bg-gradient-to-r from-cyan-500 to-blue-500',
                    'good': 'bg-gradient-to-r from-emerald-500 to-teal-500',
                    'fair': 'bg-gradient-to-r from-amber-500 to-orange-500',
                    'overdue': 'bg-gradient-to-r from-rose-500 to-pink-500',
                    'error': 'bg-gray-400'
                },

                rankConfig: {
                    'DIAMOND': { emoji: 'üíé', color: 'from-cyan-400 to-blue-500' },
                    'PLATINUM': { emoji: '‚ô¶Ô∏è', color: 'from-emerald-400 to-teal-500' },
                    'GOLD': { emoji: 'ü•á', color: 'from-yellow-400 to-orange-500' },
                    'SILVER': { emoji: 'ü•à', color: 'from-slate-300 to-slate-400' },
                    'BRONZE': { emoji: 'ü•â', color: 'from-orange-700 to-amber-900' },
                    'UNRANKED': { emoji: '‚ö™', color: 'from-gray-400 to-gray-500' }
                },

                get expPercentage() {
                    if (!this.profile.total_mp || !this.profile.next_rank_mp) return 0;
                    const current = this.profile.total_mp;
                    const next = this.profile.next_rank_mp;
                    if (next <= current) return 100;
                    return Math.min(100, Math.round((current / next) * 100));
                },

                get groupedHistory() {
                    const groups = {};
                    this.history.forEach(item => {
                        if (!groups[item.date]) groups[item.date] = [];
                        groups[item.date].push(item);
                    });
                    return Object.keys(groups).sort((a, b) => b.localeCompare(a)).map(date => ({
                        date,
                        items: groups[date]
                    }));
                },

                async init() {
                    try {
                        await liff.init({ liffId: '2008789653-1d4rx1nO' });
                        if (!liff.isLoggedIn()) {
                            liff.login();
                            return;
                        }

                        const idToken = liff.getDecodedIDToken();
                        if (!idToken || !idToken.email) {
                            throw new Error('Could not retrieve email from LIFF ID Token');
                        }

                        console.log('User Email:', idToken.email);

                        await Promise.all([
                            this.fetchData(idToken.email),
                            this.fetchHistory(idToken.email)
                        ]);

                        this.isLoading = false;

                        // Check for rank up celebration
                        if (this.profile.is_rank_up) {
                            setTimeout(() => this.showRankup = true, 500);
                        }

                        // Render chart after DOM is ready
                        this.$nextTick(() => {
                            this.renderDeptChart();
                        });

                    } catch (err) {
                        console.error('Initialization failed', err);
                        alert('Initialization Error: ' + err.message);
                        this.isLoading = false;
                    }
                },

                async fetchData(email) {
                    try {
                        const [profileRes, leaderboardRes, systemRes] = await Promise.all([
                            this.callAPI('getProfile', { email }),
                            this.callAPI('getLeaderboard', { limit: 20 }),
                            this.callAPI('getSystemStatus')
                        ]);

                        if (profileRes.success) {
                            this.profile = profileRes.profile;
                            this.recentScores = JSON.parse(this.profile.recent_scores_json || '[]');
                        }

                        if (leaderboardRes.success) {
                            this.leaderboard = leaderboardRes.leaderboard;
                        }

                        if (systemRes.success) {
                            this.system = systemRes.system;
                        }
                    } catch (err) {
                        console.error('Fetch data failed', err);
                    }
                },

                async callAPI(action, params = {}) {
                    try {
                        const query = new URLSearchParams({ action, ...params }).toString();
                        const response = await fetch(`${WEB_APP_URL}?${query}`);
                        return await response.json();
                    } catch (err) {
                        console.error(`API Call failed: ${action}`, err);
                        return { success: false, message: err.message };
                    }
                },

                async fetchHistory(email, page = 1) {
                    this.isLoadingHistory = true;
                    try {
                        const res = await this.callAPI('getHistory', { email, page, limit: 20 });
                        if (res.status === 'success') {
                            if (page === 1) this.history = [];
                            this.history = [...this.history, ...res.data.history];
                            this.historyTotal = res.data.total;
                            this.historyHasMore = res.data.hasMore;
                            this.historyPage = page;
                        }
                    } catch (err) {
                        console.error('History fetch failed', err);
                    } finally {
                        this.isLoadingHistory = false;
                    }
                },

                async loadMoreHistory() {
                    if (this.isLoadingHistory || !this.historyHasMore) return;
                    await this.fetchHistory(this.profile.email, this.historyPage + 1);
                },

                formatThaiDate(dateStr) {
                    if (!dateStr) return '---';
                    const date = new Date(dateStr);
                    const day = date.getDate();
                    const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                    const month = monthNames[date.getMonth()];
                    const thaiYear = ((date.getFullYear() + 543) % 100).toString().padStart(2, '0');
                    return `${day} ${month} ${thaiYear}`;
                },

                async closeRankup() {
                    this.showRankup = false;
                    await this.callAPI('clearRankUp', { email: this.profile.email });
                },

                renderDeptChart() {
                    const ctx = document.getElementById('deptChart');
                    if (!ctx || !this.system.dept_stats) return;

                    const stats = this.system.dept_stats;
                    const labels = Object.keys(stats);
                    const data = labels.map(label => stats[label].on_time_rate);
                    const backgroundColors = labels.map(label =>
                        label === this.profile.department ? 'rgba(30, 64, 175, 0.8)' : 'rgba(148, 163, 184, 0.3)'
                    );
                    const borderColors = labels.map(label =>
                        label === this.profile.department ? 'rgba(30, 64, 175, 1)' : 'rgba(148, 163, 184, 0.5)'
                    );

                    if (this.deptChart) this.deptChart.destroy();

                    this.deptChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: backgroundColors,
                                borderColor: borderColors,
                                borderWidth: 1,
                                borderRadius: 8,
                                barThickness: 25
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => ` ${context.parsed.x}% On-time`
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { display: false },
                                    ticks: { font: { size: 9, weight: 'bold' } }
                                },
                                y: {
                                    grid: { display: false },
                                    ticks: { font: { size: 10, weight: 'bold' } }
                                }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>

</html>