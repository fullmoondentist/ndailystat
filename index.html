<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Stat - RSU Dental</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#3b82f6',
                            foreground: '#ffffff',
                        },
                        destructive: {
                            DEFAULT: '#ef4444',
                            foreground: '#ffffff',
                        },
                        muted: {
                            DEFAULT: '#f3f4f6',
                            foreground: '#6b7280',
                        },
                    },
                },
            },
        }
    </script>

    <style type="text/tailwindcss">
        @layer components {
        .checkbox {
          @apply h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500 checked:bg-red-600 checked:hover:bg-red-600;
        }
        
        .badge {
          @apply inline-flex items-center rounded-lg px-2.5 py-1 text-xs font-medium ring-1 ring-inset;
        }
        
        .avatar-circle {
          @apply rounded-full flex items-center justify-center text-white shadow-sm font-light;
        }
        
        .badge-morning {
          @apply bg-blue-50 text-blue-700 ring-blue-600/20;
        }
        
        .badge-afternoon {
          @apply bg-amber-50 text-amber-700 ring-amber-600/20;
        }
        
        .badge-evening {
          @apply bg-purple-50 text-purple-700 ring-purple-600/20;
        }
        
        .count-badge {
          @apply bg-gray-50 text-gray-700 ring-gray-600/20;
        }
        
        .badge-work {
          @apply bg-gray-100 text-gray-700 ring-gray-600/20;
        }
        
        .badge-green {
          @apply bg-green-50 text-green-700 ring-green-600/20;
        }
        
        .badge-pink {
          @apply bg-pink-50 text-pink-700 ring-pink-600/20;
        }
        
        .badge-indigo {
          @apply bg-indigo-50 text-indigo-700 ring-indigo-600/20;
        }
        
        .badge-yellow {
          @apply bg-yellow-50 text-yellow-700 ring-yellow-600/20;
        }
        
        .badge-red {
          @apply bg-red-50 text-red-700 ring-red-600/20;
        }
        
        .badge-blue {
          @apply bg-blue-50 text-blue-700 ring-blue-600/20;
        }
        
        .badge-purple {
          @apply bg-purple-50 text-purple-700 ring-purple-600/20;
        }
        
        .badge-teal {
          @apply bg-teal-50 text-teal-700 ring-teal-600/20;
        }
        
        .spinner {
          @apply inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em];
        }
        
        .spinner-sm {
          @apply h-3 w-3;
        }
        
        .spinner-lg {
          @apply h-8 w-8;
        }
        
        .toast {
          @apply fixed bottom-4 right-4 z-50 rounded-lg bg-white px-6 py-4 shadow-lg ring-1 ring-black/5;
        }
        
        .toast-success {
          @apply bg-green-50 text-green-800 ring-green-500/10;
        }
        
        .badge-stat {
          @apply inline-flex items-center text-xs text-gray-500 border border-gray-200 rounded-full px-2 py-1 bg-transparent;
        }
        
        .badge-count {
          @apply absolute -top-1.5 -right-1.5 flex items-center justify-center rounded-full bg-red-500 text-white text-[8px] min-w-3.5 h-3.5 font-medium p-0.5 leading-none;
        }
        
        .badge-active .badge-count {
          @apply bg-gray-700 text-white;
        }
        
        .score-sum {
          @apply text-xs text-gray-500 font-normal ml-1;
        }
        
        .red-yellow-sum {
          @apply text-xs text-gray-500 ml-1 flex items-center;
        }
        
        .red-dot {
          @apply w-2 h-2 rounded-full bg-red-500 mr-0.5;
        }
        
        .yellow-dot {
          @apply w-2 h-2 rounded-full bg-yellow-500 mr-0.5;
        }
        
        .dot-loading {
          display: inline-block;
          position: relative;
          width: 20px;
          text-align: left;
        }
        
        .dot-loading:after {
          content: '.';
          animation: dots 1.5s steps(3, end) infinite;
        }
        
        @keyframes dots {
          0%, 20% { content: '.'; }
          40%, 60% { content: '..'; }
          80%, 100% { content: '...'; }
        }
        
        .help-icon {
          @apply ml-1 text-gray-400 hover:text-gray-600 cursor-pointer transition-colors;
        }
        
        .help-icon-pulse {
          animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
          @apply text-blue-500;
        }
        
        @keyframes pulse {
          0%, 100% {
            opacity: 1;
            transform: scale(1);
          }
          50% {
            opacity: .8;
            transform: scale(1.1);
          }
        }
        
        .glass-card {
            @apply bg-white rounded-lg border shadow-sm;
        }
        
        .remover-gradient {
          @apply bg-clip-text text-transparent bg-gradient-to-r from-gray-500 to-gray-200 inline-block font-light;
        }
        
        .premium-gradient {
            @apply bg-gradient-to-br from-blue-600 via-indigo-600 to-violet-700;
        }

        .ticker-wrap {
            @apply w-full overflow-hidden bg-gray-900/5 py-2;
        }
        .ticker-move {
            display: inline-block;
            white-space: nowrap;
            padding-right: 100%;
            animation: ticker 30s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }

        .info-title {
          @apply text-sm font-bold text-gray-700 mb-2;
        }
        
        .info-content {
          @apply text-xs text-gray-600;
        }
        
        [x-cloak] { display: none !important; }
      }
    </style>
</head>

<body class="bg-[#F8F9FD] min-h-screen font-sans pb-12" x-data="dailyApp()" x-init="init()">

    <!-- Top Ticker (Fixed/Top) -->
    <div class="ticker-wrap border-b border-gray-100/50 bg-white/80 backdrop-blur-md sticky top-0 z-50"
        x-show="system.ticker_messages?.length > 0">
        <div class="ticker-move text-xs font-bold text-slate-600">
            <template x-for="msg in system.ticker_messages" :key="msg">
                <span class="mx-6 inline-flex items-center">
                    <span class="w-1.5 h-1.5 rounded-full bg-orange-500 mr-2"></span>
                    <span x-text="msg"></span>
                </span>
            </template>
        </div>
    </div>

    <!-- Minimal Header / Greeting -->
    <div class="container mx-auto px-4 pt-6 pb-4 max-w-md lg:max-w-[75%]">
        <div class="flex items-center justify-between">
            <div class="animate-fade-in-down">
                <div class="text-sm text-slate-500 font-medium mb-0.5">üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö,</div>
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <div class="flex items-baseline gap-2">
                        <span x-text="profile.display_name || '‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå'"
                            class="bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-slate-600"></span>
                        <span
                            class="text-[10px] font-bold tracking-wider px-2 py-0.5 rounded-full bg-blue-50 text-blue-600 border border-blue-100"
                            x-text="profile.department"></span>
                    </div>
                </h1>
            </div>
            <div class="bg-white p-2 rounded-full shadow-sm border border-slate-100 relative">
                <i class="fa-regular fa-bell text-slate-400"></i>
                <span class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <main class="px-4 pb-20">
        <div class="container mx-auto max-w-md lg:max-w-[75%] space-y-6">

            <!-- Component: Name Card (DailyRemover Style) -->
            <div class="rounded-2xl p-6 text-white shadow-xl relative overflow-hidden transition-all duration-300 transform hover:scale-[1.01]"
                :class="'bg-gradient-to-br ' + (profile.class_color_css || 'from-blue-600 via-indigo-600 to-violet-700')">

                <div class="flex justify-between items-start mb-4">
                    <!-- Left: Display Name -->
                    <div class="flex flex-col pt-2">
                        <h2 class="text-3xl font-extrabold tracking-tight drop-shadow-md" x-text="profile.display_name">
                        </h2>
                    </div>

                    <!-- Right: Rank Info -->
                    <div class="text-right flex flex-col items-end">
                        <div class="text-[2.5rem] font-black leading-none mb-1 drop-shadow-lg uppercase tracking-tight"
                            x-text="profile.current_class"></div>
                        <div
                            class="flex items-center gap-1.5 text-[10px] font-black bg-black/20 backdrop-blur-md px-2.5 py-1 rounded-md mt-1 border border-white/10 uppercase tracking-widest text-blue-50">
                            <i class="fa-solid fa-bookmark text-[10px] text-yellow-300"></i>
                            <span x-text="profile.current_title"></span>
                        </div>
                    </div>
                </div>

                <!-- Bottom: MP Progress -->
                <div class="mt-8 space-y-2">
                    <div
                        class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest opacity-90">
                        <span>MP Progress</span>
                        <div class="flex items-center gap-1.5 font-bold">
                            <span class="text-xs" x-text="profile.total_mp?.toLocaleString()"></span>
                            <span class="opacity-50">/</span>
                            <span class="text-xs" x-text="profile.next_rank_mp?.toLocaleString()"></span>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div class="h-2 w-full bg-black/20 rounded-full overflow-hidden shadow-inner">
                        <div class="h-full bg-white rounded-full transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(255,255,255,0.5)]"
                            :style="'width: ' + expPercentage + '%'"></div>
                    </div>
                </div>
            </div>

            <!-- Stats Grid (New Layout) -->
            <div class="flex items-end gap-2 mb-2 px-1">
                <h3 class="text-sm font-bold text-slate-700">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today's Stats)</h3>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <!-- Streak -->
                <div
                    class="bg-white rounded-xl p-3 flex flex-col items-center justify-center text-center shadow-sm border border-slate-100">
                    <div class="mb-1 text-lg">üî•</div>
                    <div class="text-xl font-bold text-slate-800" x-text="profile.current_streak || 0"></div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Streak</div>
                </div>
                <!-- Accuracy -->
                <div
                    class="bg-white rounded-xl p-3 flex flex-col items-center justify-center text-center shadow-sm border border-slate-100">
                    <div class="mb-1 text-lg">üéØ</div>
                    <div class="text-xl font-bold text-slate-800" x-text="(profile.recent_acc || 0) + '%'"></div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Accuracy</div>
                </div>
                <!-- Class -->
                <div
                    class="bg-white rounded-xl p-3 flex flex-col items-center justify-center text-center shadow-sm border border-slate-100">
                    <div class="mb-1 text-lg">üíé</div>
                    <div class="text-xl font-bold text-slate-800 truncate w-full px-1"
                        x-text="(profile.current_class || 'NONE').split(' ')[0]"></div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Class</div>
                </div>
            </div>

            <!-- Rewards Box (Clean) -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100/60">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-slate-700">üéÅ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (Reward Box)</h3>
                    <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-md"
                        x-text="profile.rewards?.length + ' ‡∏ä‡∏¥‡πâ‡∏ô'"></span>
                </div>

                <div class="bg-slate-50/50 rounded-xl p-4 border border-dashed border-slate-200">
                    <div class="flex flex-wrap gap-3 items-center justify-start">
                        <template x-for="reward in groupedRewards" :key="reward.name">
                            <div class="relative group cursor-help">
                                <span class="text-3xl filter drop-shadow-sm transition-transform hover:scale-110"
                                    x-text="getRewardEmoji(reward.name)"></span>
                                <span
                                    class="absolute -top-2 -right-2 bg-slate-800 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm"
                                    x-show="reward.count > 1" x-text="reward.count"></span>
                            </div>
                        </template>
                        <div x-show="!profile.rewards || profile.rewards.length === 0"
                            class="text-xs text-slate-400 italic w-full text-center py-2">
                            ‡∏™‡∏∞‡∏™‡∏° MP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•...
                        </div>
                    </div>
                    <div class="mt-3 text-[10px] text-slate-400 text-center font-medium">
                        ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 100% Perfect
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-3">
                <button
                    class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-slate-50 text-slate-700">
                    <i class="fa-solid fa-stethoscope text-blue-500"></i>
                    <span class="text-sm font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</span>
                </button>
                <a href="#history-section"
                    @click.prevent="document.getElementById('history-section').scrollIntoView({behavior: 'smooth'})"
                    class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-slate-50 text-slate-700">
                    <i class="fa-solid fa-clock-rotate-left text-orange-500"></i>
                    <span class="text-sm font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                </a>
            </div>

            <!-- Department Overview (Preview) -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100/60">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-slate-700">üè¢ Department Overview</h3>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Preview</span>
                </div>
                <div class="space-y-3">
                    <!-- Loop simplified standard stats or manual top 3 -->
                    <template x-for="(stat, dept) in system.dept_stats" :key="dept">
                        <div x-show="Object.keys(system.dept_stats).indexOf(dept) < 3" class="flex items-center gap-3">
                            <div class="w-6 text-[10px] font-bold text-slate-400 text-center"
                                x-text="['ü•á','ü•à','ü•â'][Object.keys(system.dept_stats).indexOf(dept)]"></div>
                            <div class="flex-1">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="font-bold text-slate-700" x-text="dept"></span>
                                    <span class="font-bold"
                                        :class="stat.on_time_rate >= 80 ? 'text-green-600' : 'text-slate-500'"
                                        x-text="stat.on_time_rate + '%'"></span>
                                </div>
                                <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full"
                                        :class="dept === profile.department ? 'bg-blue-500' : (stat.on_time_rate >= 80 ? 'bg-green-400' : 'bg-slate-300')"
                                        :style="'width: ' + stat.on_time_rate + '%'"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                    <div class="pt-2 text-center">
                        <button class="text-xs font-bold text-blue-500 hover:text-blue-600 transition-colors">View Full
                            Leaderboard</button>
                    </div>
                </div>
            </div>

            <!-- Department Leaderboard (Full View) -->
            <div id="dept-leaderboard-section"
                class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100/60 scroll-mt-20">
                <div
                    class="bg-gradient-to-r from-slate-50 to-white p-3 rounded-xl border border-slate-100 mb-4 text-center">
                    <h3 class="text-sm font-bold text-slate-700">üè¢ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                    <div class="text-[10px] text-slate-400">Department Leaderboard</div>
                </div>

                <div class="space-y-6">
                    <template x-for="(stat, dept) in system.dept_stats" :key="dept">
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg"
                                        x-text="['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£'][Object.keys(system.dept_stats).indexOf(dept)] || (Object.keys(system.dept_stats).indexOf(dept)+1) + '.'"></span>
                                    <span class="text-sm font-bold text-slate-700" x-text="dept"></span>
                                    <span x-show="dept === profile.department"
                                        class="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded font-bold">You</span>
                                </div>
                                <div class="text-xs font-bold"
                                    x-text="stat.on_time_rate + '% (' + (stat.on_time_rate >= 80 ? 'Excellent' : (stat.on_time_rate >= 50 ? 'Good' : 'Need Help')) + ')'"
                                    :class="stat.on_time_rate >= 80 ? 'text-green-600' : (stat.on_time_rate >= 50 ? 'text-yellow-600' : 'text-red-500')">
                                </div>
                            </div>
                            <div class="w-full h-4 bg-slate-100 rounded-sm overflow-hidden flex">
                                <!-- Bar segments mimicking mockup -->
                                <div class="h-full"
                                    :class="stat.on_time_rate >= 80 ? 'bg-blue-500' : (stat.on_time_rate >= 60 ? 'bg-green-500' : (stat.on_time_rate >= 40 ? 'bg-yellow-400' : 'bg-red-400'))"
                                    :style="'width: ' + stat.on_time_rate + '%'"></div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Insight Box -->
                <div class="mt-6 bg-yellow-50/50 border border-yellow-100 rounded-xl p-4 relative">
                    <div class="absolute -top-3 left-4 bg-white px-2 text-lg">üí°</div>
                    <div class="mt-2 text-xs text-slate-600 italic">
                        "‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ <span class="font-bold text-slate-800"
                            x-text="Object.keys(system.dept_stats)[0]"></span> ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏Ñ‡∏£‡∏±‡∏ö! ü¶∑"
                    </div>
                </div>
            </div>

            <!-- History / Logs -->
            <div id="history-section"
                class="bg-white rounded-2xl shadow-sm border border-slate-100/60 overflow-hidden scroll-mt-24">
                <div
                    class="bg-slate-50 border-b border-slate-100 p-4 sticky top-14 z-10 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left text-slate-400"></i>
                        <h3 class="text-sm font-bold text-slate-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today)</h3>
                    </div>
                </div>

                <div class="divide-y divide-slate-50">
                    <template x-for="item in history" :key="item.date + item.session">
                        <div class="p-4 bg-white">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-slate-400"
                                    x-text="'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ' + item.session + ': ' + item.time + ' ‡∏ô.'"></span>
                                <span class="text-xs font-bold text-slate-800" x-text="'‡∏ô‡∏®. ' + item.student"></span>
                            </div>

                            <!-- Card Content based on Status -->
                            <div class="rounded-lg p-3 border-l-4"
                                :class="item.status === 'perfect' ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid"
                                            :class="item.status === 'perfect' ? 'fa-circle-check text-green-500' : 'fa-circle-exclamation text-red-500'"></i>
                                        <span class="text-xs font-bold"
                                            :class="item.status === 'perfect' ? 'text-green-700' : 'text-red-700'"
                                            x-text="item.status === 'perfect' ? 'PERFECT (+100 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)' : 'OVERDUE (0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)'"></span>
                                    </div>
                                    <div class="text-lg" x-text="item.status === 'perfect' ? '‚úÖ' : '‚ùå'"></div>
                                </div>
                                <div class="text-[10px]"
                                    :class="item.status === 'perfect' ? 'text-green-600' : 'text-red-600'">
                                    <div x-show="item.status === 'perfect'" class="flex items-center gap-1">
                                        ‚è±Ô∏è ‡∏™‡πà‡∏á‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Delta <span x-text="Math.abs(item.delta)"></span> min)
                                    </div>
                                    <div x-show="item.status !== 'perfect'">
                                        üïí ‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤: <span x-text="Math.floor(Math.abs(item.delta)/60) + ' ‡∏ä‡∏°.'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div x-show="historyHasMore" class="p-4 bg-slate-50">
                    <button @click="loadMoreHistory()" :disabled="isLoadingHistory"
                        class="w-full py-3 rounded-xl bg-white border border-slate-200 text-xs font-bold text-slate-500 hover:text-blue-500 transition-colors shadow-sm">
                        ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...
                    </button>
                </div>
            </div>

        </div>
    </main>


    <!-- Rankup Celebration Modal (Screen 1) -->
    <div x-show="showRankup" x-cloak
        class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm"
        x-transition.opacity>
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 text-center relative overflow-hidden shadow-2xl"
            x-transition:enter="transition ease-out duration-500 scale-90 opacity-0"
            x-transition:enter-start="scale-90 opacity-0" x-transition:enter-end="scale-100 opacity-100">

            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500">
            </div>

            <div class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-1">‚ú® CONGRATULATIONS ‚ú®</div>
            <div class="text-4xl mb-4 animate-bounce">üéâ</div>

            <h2 class="text-lg font-bold text-slate-600 mb-2">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô:</h2>

            <div
                :class="'inline-flex items-center px-5 py-2 rounded-full text-white font-bold shadow-lg mb-6 bg-gradient-to-r ' + (rankConfig[profile.current_class]?.color || 'from-blue-600 to-indigo-600')">
                <span x-text="rankConfig[profile.current_class]?.emoji || 'üèÜ'"></span>
                <span x-text="profile.current_class" class="ml-2 uppercase tracking-widest text-lg"></span>
            </div>

            <div class="border-t border-slate-100 py-4 mb-4">
                <h3 class="text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                <div class="space-y-2 text-sm text-slate-700">
                    <div class="flex justify-between px-4">
                        <span class="text-slate-500">Total MP:</span>
                        <span class="font-bold" x-text="profile.total_mp?.toLocaleString() || 0"></span>
                    </div>
                    <div class="flex justify-between px-4">
                        <span class="text-slate-500">Bonus:</span>
                        <span class="font-bold text-green-600">x1.2 Multiplier</span>
                    </div>
                    <div class="flex justify-between px-4">
                        <span class="text-slate-500">Unlock:</span>
                        <span class="font-bold text-orange-500">‡∏Å‡∏£‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏≠‡∏á ‚≠ê</span>
                    </div>
                </div>
            </div>

            <button @click="closeRankup()"
                class="w-full py-3.5 bg-slate-800 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform hover:bg-slate-900">
                ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏∏‡∏¢‡∏ï‡πà‡∏≠! üöÄ
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div x-show="isLoading" x-cloak
        class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center space-y-6">
        <div class="spinner spinner-lg text-blue-600"></div>
        <div class="text-xs font-bold text-gray-400 tracking-wider uppercase">NongDaily Stat</div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/a/macros/rsu.ac.th/s/AKfycbxWTt29Ry2K8upGAFQV1rnxFnDHB9IUb4ahim3tZXFVvOUZv3jqxrrQnZ61NbTz6CdmHA/exec'; // REPLACE WITH ACTUAL URL

        function dailyApp() {
            return {
                isLoading: true,
                showRankup: false,
                profile: {},
                userId: null,
                system: {},
                leaderboard: [],
                recentScores: [],
                deptChart: null,

                // History state
                history: [],
                historyPage: 1,
                historyTotal: 0,
                historyHasMore: false,
                isLoadingHistory: false,

                statusColors: {
                    'perfect': 'bg-gradient-to-r from-cyan-500 to-blue-500',
                    'good': 'bg-gradient-to-r from-emerald-500 to-teal-500',
                    'fair': 'bg-gradient-to-r from-amber-500 to-orange-500',
                    'overdue': 'bg-gradient-to-r from-rose-500 to-pink-500',
                    'error': 'bg-gray-400'
                },

                rankConfig: {
                    'DIAMOND': { emoji: 'üíé', color: 'from-cyan-400 to-blue-500' },
                    'PLATINUM': { emoji: '‚ô¶Ô∏è', color: 'from-emerald-400 to-teal-500' },
                    'GOLD': { emoji: 'ü•á', color: 'from-yellow-400 to-orange-500' },
                    'SILVER': { emoji: 'ü•à', color: 'from-slate-300 to-slate-400' },
                    'BRONZE': { emoji: 'ü•â', color: 'from-orange-700 to-amber-900' },
                    'UNRANKED': { emoji: '‚ö™', color: 'from-gray-400 to-gray-500' }
                },

                get expPercentage() {
                    if (!this.profile.total_mp || !this.profile.next_rank_mp) return 0;
                    const current = this.profile.total_mp;
                    const next = this.profile.next_rank_mp;
                    if (next <= current) return 100;
                    return Math.min(100, Math.round((current / next) * 100));
                },

                get groupedRewards() {
                    if (!this.profile.rewards) return [];
                    const counts = {};
                    this.profile.rewards.forEach(r => {
                        counts[r] = (counts[r] || 0) + 1;
                    });
                    return Object.entries(counts).map(([name, count]) => ({ name, count }));
                },

                getRewardEmoji(name) {
                    const map = {
                        'Rose': 'üåπ',
                        'Heart': '‚ù§Ô∏è',
                        'Diamond': 'üíé'
                    };
                    return map[name] || 'üéÅ';
                },

                async init() {
                    try {
                        await liff.init({ liffId: '2008789653-GNraHzM6' });
                        if (!liff.isLoggedIn()) {
                            liff.login();
                            return;
                        }

                        const idToken = liff.getDecodedIDToken();
                        let email = idToken ? idToken.email : null;
                        let userId = null;

                        if (!email) {
                            console.log('Email not found in ID Token, falling back to liff.getProfile()');
                            const profile = await liff.getProfile();
                            userId = profile.userId;
                        }

                        console.log('Auth Identifier:', email || userId);
                        this.userId = userId; // Store for global use

                        await Promise.all([
                            this.fetchData(email || undefined, userId || undefined),
                            this.fetchHistory(email || undefined, userId || undefined)
                        ]);

                        this.isLoading = false;

                        // Check for rank up celebration
                        if (this.profile.is_rank_up) {
                            setTimeout(() => this.showRankup = true, 500);
                        }

                        // Chart render removed

                    } catch (err) {
                        console.error('Initialization failed', err);
                        alert('Initialization Error: ' + err.message);
                        this.isLoading = false;
                    }
                },

                async fetchData(email, userId) {
                    try {
                        const [profileRes, leaderboardRes, systemRes] = await Promise.all([
                            this.callAPI('getProfile', { email, userId }),
                            this.callAPI('getLeaderboard', { limit: 20 }),
                            this.callAPI('getSystemStatus')
                        ]);

                        console.log('Profile Response:', profileRes);

                        if (profileRes.success) {
                            this.profile = profileRes.profile;
                            // Also ensure userId is stored if it came back from backend
                            if (!this.userId && this.profile.userId) this.userId = this.profile.userId;

                            this.recentScores = JSON.parse(this.profile.recent_scores_json || '[]');
                        } else {
                            console.warn('Profile fetch failed:', profileRes);
                        }

                        if (leaderboardRes.success) {
                            this.leaderboard = leaderboardRes.leaderboard;
                        }

                        if (systemRes.success) {
                            this.system = systemRes.system;
                        }
                    } catch (err) {
                        console.error('Fetch data failed', err);
                    }
                },

                async callAPI(action, params = {}) {
                    try {
                        // Use userId from state if not provided and profile not yet set
                        const activeUserId = params.userId || this.userId || (this.profile && this.profile.userId);
                        if (activeUserId && !params.userId) {
                            params.userId = activeUserId;
                        }

                        const query = new URLSearchParams({ action, ...params }).toString();
                        const response = await fetch(`${WEB_APP_URL}?${query}`);
                        return await response.json();
                    } catch (err) {
                        console.error(`API Call failed: ${action}`, err);
                        return { success: false, message: err.message };
                    }
                },

                async fetchHistory(email, userId, page = 1) {
                    this.isLoadingHistory = true;
                    try {
                        const res = await this.callAPI('getHistory', { email, userId, page, limit: 20 });
                        if (res.success) {
                            if (page === 1) this.history = [];
                            this.history = [...this.history, ...res.data.history];
                            this.historyTotal = res.data.total;
                            this.historyHasMore = res.data.hasMore;
                            this.historyPage = page;
                        }
                    } catch (err) {
                        console.error('History fetch failed', err);
                    } finally {
                        this.isLoadingHistory = false;
                    }
                },

                async loadMoreHistory() {
                    if (this.isLoadingHistory || !this.historyHasMore) return;
                    await this.fetchHistory(this.profile.email, this.userId, this.historyPage + 1);
                },

                formatThaiDate(dateStr) {
                    if (!dateStr) return '---';
                    const date = new Date(dateStr);
                    const day = date.getDate();
                    const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                    const month = monthNames[date.getMonth()];
                    const thaiYear = ((date.getFullYear() + 543) % 100).toString().padStart(2, '0');
                    return `${day} ${month} ${thaiYear}`;
                },

                getInitials(email) {
                    if (!email) return '??';
                    // ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô @rsu.ac.th ‡∏≠‡∏≠‡∏Å
                    const username = email.split('@')[0];

                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏°‡∏µ‡∏à‡∏∏‡∏î (.) ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠
                    if (username.includes('.')) {
                        const parts = username.split('.');
                        return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
                    }

                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∏‡∏î ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏™‡∏£‡∏∞
                    const vowels = ['a', 'e', 'i', 'o', 'u'];
                    for (let i = 0; i < username.length - 1; i++) {
                        if (vowels.includes(username[i].toLowerCase())) {
                            return (username[0] + username[i + 1]).toUpperCase();
                        }
                    }

                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 3: ‡πÉ‡∏ä‡πâ‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
                    return username.substring(0, 2).toUpperCase();
                },

                async closeRankup() {
                    this.showRankup = false;
                    await this.callAPI('clearRankUp', { email: this.profile.email });
                },

            }
        }
    </script>
</body>

</html>
