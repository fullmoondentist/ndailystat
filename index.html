<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#3b82f6',
                            foreground: '#ffffff',
                        },
                        destructive: {
                            DEFAULT: '#ef4444',
                            foreground: '#ffffff',
                        },
                        muted: {
                            DEFAULT: '#f3f4f6',
                            foreground: '#6b7280',
                        },
                    },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer components {
            .checkbox {
                @apply h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500 checked:bg-red-600 checked:hover:bg-red-600;
            }

            .badge {
                @apply inline-flex items-center rounded-lg px-2.5 py-1 text-xs font-medium ring-1 ring-inset;
            }

            .avatar-circle {
                @apply w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm;
            }

            .spinner {
                @apply inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em];
            }

            .help-icon {
                @apply ml-1 text-gray-400 hover:text-gray-600 cursor-pointer transition-colors;
            }

            .help-icon-pulse {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: .8; transform: scale(1.1); }
            }

            .modal-backdrop {
                @apply fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] transition-opacity;
            }

            .modal-bottom-sheet {
                @apply fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl z-[101] transform transition-transform duration-300 ease-in-out;
                max-height: 90vh;
                overflow-y: auto;
            }

            [x-cloak] { display: none !important; }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen text-slate-900 font-sans" x-data="dailyApp()" x-init="init()">
    <!-- Header -->
    <header class="border-b bg-white sticky top-0 z-[60]">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div class="flex justify-between items-center">
                    <div class="flex flex-col">
                        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">
                            <i class="fa-solid fa-person-chalkboard text-blue-600 mr-2"></i>Case<span
                                class="font-light">Present</span>
                        </h1>
                        <p class="text-[10px] font-bold uppercase tracking-widest text-slate-500 md:block hidden mt-1">
                            Dental Medicine RSU</p>
                    </div>
                    <div class="text-right text-[10px] font-bold uppercase tracking-widest text-slate-400 md:hidden">
                        <div>Dental Medicine RSU</div>
                    </div>
                </div>
                <!-- User Profile Header Section -->
                <div class="flex flex-col items-start md:items-end mt-2 md:mt-0">
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col items-end">
                            <div class="text-xs font-bold text-slate-700" x-text="profile.display_name || 'Loading...'">
                            </div>
                            <div class="text-[9px] font-black uppercase tracking-widest text-blue-600 px-1.5 py-0.5 bg-blue-50 rounded"
                                x-text="profile.department || '---'"></div>
                        </div>
                        <div class="avatar-circle"
                            :class="profile.class_color_css ? ('bg-gradient-to-br ' + profile.class_color_css) : 'bg-slate-300'">
                            <span x-text="getInitials(profile.email || '')"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="px-4 py-6">
        <div class="container mx-auto w-full lg:max-w-[75%] space-y-6">

            <!-- Component: Name Card (User Requested Style) -->
            <div id="nameCard"
                class="bg-white rounded-2xl border shadow-sm p-6 relative overflow-hidden transition-all duration-300"
                x-cloak x-show="!isLoading">
                <div class="flex justify-between items-start">
                    <!-- Left: Profile Info -->
                    <div class="flex flex-col">
                        <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 mb-1">User Profile
                        </div>
                        <h2 class="text-3xl font-black text-slate-900 tracking-tight" x-text="profile.display_name">
                        </h2>
                        <div class="text-xs font-bold text-blue-600 mt-1 flex items-center gap-1.5">
                            <i class="fa-solid fa-building-columns"></i>
                            <span x-text="profile.department"></span>
                        </div>
                    </div>

                    <!-- Right: Rank Info -->
                    <div class="text-right flex flex-col items-end">
                        <div class="text-[2.5rem] font-black leading-none tracking-tighter"
                            :class="profile.class_color_css ? 'bg-clip-text text-transparent bg-gradient-to-br ' + profile.class_color_css : 'text-slate-800'"
                            x-text="profile.current_class"></div>
                        <div
                            class="flex items-center gap-1.5 text-[10px] font-black bg-slate-900 text-white px-3 py-1.5 rounded-full mt-2 uppercase tracking-widest">
                            <i class="fa-solid fa-bookmark text-yellow-400"></i>
                            <span x-text="profile.current_title"></span>
                        </div>
                    </div>
                </div>

                <!-- MP Progress Bar -->
                <div class="mt-8 pt-6 border-t border-slate-50">
                    <div
                        class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-500 mb-2.5">
                        <span class="flex items-center gap-1.5"><i class="fa-solid fa-star text-yellow-500"></i> MP
                            Progress</span>
                        <div class="flex items-baseline gap-1">
                            <span class="text-xs text-slate-900" x-text="profile.total_mp?.toLocaleString()"></span>
                            <span class="text-slate-300 font-normal">/</span>
                            <span class="text-xs text-slate-400"
                                x-text="profile.next_rank_mp?.toLocaleString() || 'MAX'"></span>
                        </div>
                    </div>
                    <!-- The Bar -->
                    <div class="h-2.5 w-full bg-slate-100 rounded-full overflow-hidden shadow-inner flex">
                        <div class="h-full rounded-full transition-all duration-1000 ease-out"
                            :class="profile.class_color_css ? 'bg-gradient-to-r ' + profile.class_color_css : 'bg-blue-600'"
                            :style="'width: ' + expPercentage + '%'"></div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="isLoading"
                class="flex flex-col items-center justify-center p-20 bg-white rounded-2xl border shadow-sm">
                <div class="spinner h-8 w-8 text-blue-600 mb-4"></div>
                <div class="text-sm font-bold text-slate-500 uppercase tracking-widest">Loading Data...</div>
            </div>

        </div>
    </main>

    <script>
        const WEB_APP_URL = "https://script.google.com/a/macros/rsu.ac.th/s/AKfycbyk0TzBIdwD_7XjO6LgV79M_nQW_z1G0u_h_V6v6Z_z/exec"; // PLACEHOLDER - ScriptApp.getService().getUrl() actually used in template logic usually

        function dailyApp() {
            return {
                profile: {},
                system: {},
                leaderboard: [],
                isLoading: true,
                userId: null,

                async init() {
                    console.log("Initializing App...");
                    try {
                        // LIFF Initialization
                        await liff.init({ liffId: '2008789653-GNraHzM6' });
                        if (!liff.isLoggedIn()) {
                            liff.login();
                            return;
                        }

                        const idToken = liff.getDecodedIDToken();
                        let email = idToken ? idToken.email : null;
                        let userId = null;

                        if (!email) {
                            const p = await liff.getProfile();
                            userId = p.userId;
                        }

                        this.userId = userId;
                        await this.fetchData(email, userId);
                        this.isLoading = false;
                    } catch (err) {
                        console.error("Init failed", err);
                        this.isLoading = false;
                    }
                },

                async fetchData(email, userId) {
                    try {
                        const [profileRes, systemRes, leaderboardRes] = await Promise.all([
                            this.callAPI('getProfile', { email, userId }),
                            this.callAPI('getSystemStatus'),
                            this.callAPI('getLeaderboard', { limit: 10 })
                        ]);

                        if (profileRes.success) {
                            this.profile = profileRes.profile;
                            if (this.profile.userId) this.userId = this.profile.userId;
                        }
                        if (systemRes.success) this.system = systemRes.system;
                        if (leaderboardRes.success) this.leaderboard = leaderboardRes.leaderboard;
                    } catch (err) {
                        console.error("Fetch failed", err);
                    }
                },

                async callAPI(action, params = {}) {
                    const activeUserId = params.userId || this.userId;
                    const query = new URLSearchParams({ action, ...params, userId: activeUserId || '' }).toString();
                    const response = await fetch(`${WEB_APP_URL}?${query}`);
                    return await response.json();
                },

                get expPercentage() {
                    if (!this.profile.total_mp || !this.profile.next_rank_mp) return 0;
                    return Math.min(100, Math.round((this.profile.total_mp / this.profile.next_rank_mp) * 100));
                },

                getInitials(email) {
                    if (!email) return '..';
                    const name = email.split('@')[0];
                    if (name.includes('.')) {
                        const parts = name.split('.');
                        return (parts[0][0] + parts[1][0]).toUpperCase();
                    }
                    return name.substring(0, 2).toUpperCase();
                }
            }
        }
    </script>
</body>

</html>
