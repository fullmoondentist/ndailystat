<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#3b82f6',
                            foreground: '#ffffff',
                        },
                        destructive: {
                            DEFAULT: '#ef4444',
                            foreground: '#ffffff',
                        },
                        muted: {
                            DEFAULT: '#f3f4f6',
                            foreground: '#6b7280',
                        },
                    },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer components {
        .checkbox {
          @apply h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500 checked:bg-red-600 checked:hover:bg-red-600;
        }

        .badge {
          @apply inline-flex items-center rounded-lg px-2.5 py-1 text-xs font-medium ring-1 ring-inset;
        }

        .avatar-circle {
          @apply w-6 h-6 rounded-full bg-gray-400 flex items-center justify-center text-xs font-light text-white;
        }

        .badge-morning {
          @apply bg-blue-50 text-blue-700 ring-blue-600/20;
        }

        .badge-afternoon {
          @apply bg-amber-50 text-amber-700 ring-amber-600/20;
        }

        .badge-evening {
          @apply bg-purple-50 text-purple-700 ring-purple-600/20;
        }

        .count-badge {
          @apply bg-gray-50 text-gray-700 ring-gray-600/20;
        }

        .badge-work {
          @apply bg-gray-100 text-gray-700 ring-gray-600/20;
        }

        .badge-green {
          @apply bg-green-50 text-green-700 ring-green-600/20;
        }

        .badge-pink {
          @apply bg-pink-50 text-pink-700 ring-pink-600/20;
        }

        .badge-indigo {
          @apply bg-indigo-50 text-indigo-700 ring-indigo-600/20;
        }

        .badge-yellow {
          @apply bg-yellow-50 text-yellow-700 ring-yellow-600/20;
        }

        .badge-red {
          @apply bg-red-50 text-red-700 ring-red-600/20;
        }

        .badge-blue {
          @apply bg-blue-50 text-blue-700 ring-blue-600/20;
        }

        .badge-purple {
          @apply bg-purple-50 text-purple-700 ring-purple-600/20;
        }

        .badge-teal {
          @apply bg-teal-50 text-teal-700 ring-teal-600/20;
        }

        .spinner {
          @apply inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em];
        }

        .spinner-sm {
          @apply h-3 w-3;
        }

        .spinner-lg {
          @apply h-8 w-8;
        }

        .toast {
          @apply fixed bottom-4 right-4 z-50 rounded-lg bg-white px-6 py-4 shadow-lg ring-1 ring-black/5;
        }

        .toast-success {
          @apply bg-green-50 text-green-800 ring-green-500/10;
        }

        .badge-stat {
          @apply inline-flex items-center text-xs text-gray-500 border border-gray-200 rounded-full px-2 py-0.5 bg-transparent;
        }

        .score-sum {
          @apply text-xs text-gray-500 font-normal ml-1;
        }

        .red-yellow-sum {
          @apply text-xs text-gray-500 ml-1 flex items-center;
        }

        .red-dot {
          @apply w-2 h-2 rounded-full bg-red-500 mr-0.5;
        }

        .yellow-dot {
          @apply w-2 h-2 rounded-full bg-yellow-500 mr-0.5;
        }

        .dot-loading {
          display: inline-block;
          position: relative;
          width: 20px;
          text-align: left;
        }

        .dot-loading:after {
          content: '.';
          animation: dots 1.5s steps(3, end) infinite;
        }

        @keyframes dots {
          0%, 20% { content: '.'; }
          40%, 60% { content: '..'; }
          80%, 100% { content: '...'; }
        }

        .help-icon {
          @apply ml-1 text-gray-400 hover:text-gray-600 cursor-pointer transition-colors;
        }

        .help-icon-pulse {
          animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
          0%, 100% {
            opacity: 1;
            transform: scale(1);
          }
          50% {
            opacity: .8;
            transform: scale(1.1);
          }
        }

        .modal-backdrop {
          @apply fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity;
        }

        .modal-bottom-sheet {
          @apply fixed bottom-0 left-0 right-0 bg-white rounded-t-xl shadow-xl z-50 transform transition-transform duration-300 ease-in-out;
          max-height: 90vh;
          overflow-y: auto;
        }

        .modal-bottom-sheet.hidden {
          transform: translateY(100%);
        }

        .modal-bottom-sheet.visible {
          transform: translateY(0);
        }

        .modal-drag-handle {
          @apply w-12 h-1.5 bg-gray-300 rounded-full mx-auto my-3;
        }

        .info-section {
          @apply border-b border-gray-200 p-4;
        }

        .info-section:last-child {
          @apply border-b-0;
        }

        .info-title {
          @apply text-sm font-medium text-gray-700 mb-2;
        }

        .info-content {
          @apply text-xs text-gray-600;
        }

        .icon-legend {
          @apply flex items-center gap-2 py-1;
        }

        .remover-gradient {
          @apply bg-clip-text text-transparent bg-gradient-to-r from-gray-500 to-gray-200 inline-block font-light;
        }

        [x-cloak] { display: none !important; }
      }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans" x-data="dailyApp()" x-init="init()">
    <header class="border-b bg-white">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div class="flex justify-between items-center">
                    <div class="flex flex-col">
                        <h1 class="text-2xl font-bold text-gray-900">
                            <i class="fa-solid fa-person-chalkboard mr-2"></i>Case<span
                                class="font-light">Present</span>
                        </h1>
                        <p class="text-sm text-gray-500 md:block hidden mt-1">Dental Medicine RSU</p>
                    </div>
                    <div class="text-right text-xs text-gray-500 md:hidden">
                        <div>Dental Medicine RSU</div>
                    </div>
                </div>
                <div class="flex flex-col items-start md:items-end mt-2 md:mt-0">
                    <div class="md:border-t-0 pt-2 md:pt-0 w-full">
                        <div
                            class="flex items-center text-gray-400 flex-wrap justify-start md:justify-end gap-2 text-left md:text-right">
                            <div class="avatar-circle">
                                <span x-text="getInitials(profile.email || '')"></span>
                            </div>
                            <div class="flex gap-2">
                                <div class="help-icon" id="helpButton">
                                    <i class="fa-solid fa-circle-question"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="px-4 py-8">
        <div class="container mx-auto w-full lg:max-w-[75%] space-y-4">

            <!-- Component: Name Card (Matching Template Main Container Style) -->
            <div id="nameCard" class="bg-white rounded-lg border shadow-sm p-8" x-cloak x-show="!isLoading">
                <div class="flex justify-between items-start">
                    <div class="flex flex-col">
                        <h2 class="text-2xl font-bold text-gray-900" x-text="profile.display_name"></h2>
                        <p class="text-sm text-gray-500" x-text="profile.department"></p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-gray-900" x-text="profile.current_class"></div>
                        <div class="text-sm text-gray-500" x-text="profile.current_title"></div>
                    </div>
                </div>

                <!-- MP Progress (Simple Bar matching Template aesthetics) -->
                <div class="mt-8">
                    <div class="flex justify-between text-xs font-medium text-gray-500 mb-2">
                        <span>MP Progress</span>
                        <span
                            x-text="profile.total_mp?.toLocaleString() + ' / ' + (profile.next_rank_mp?.toLocaleString() || 'MAX')"></span>
                    </div>
                    <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden border">
                        <div class="h-full bg-blue-500 transition-all duration-1000"
                            :style="'width: ' + expPercentage + '%'"></div>
                    </div>
                </div>
            </div>

            <!-- Initializing State -->
            <div x-show="isLoading" class="bg-white rounded-lg border shadow-sm p-8 text-center">
                <div class="spinner spinner-lg text-blue-500 mb-4"></div>
                <p class="text-gray-500">Initializing Session...</p>
            </div>

        </div>
    </main>

    <script>
        const WEB_APP_URL = "https://script.google.com/a/macros/rsu.ac.th/s/AKfycbyk0TzBIdwD_7XjO6LgV79M_nQW_z1G0u_h_V6v6Z_z/exec";

        function dailyApp() {
            return {
                profile: {},
                isLoading: true,
                userId: null,

                async init() {
                    try {
                        await liff.init({ liffId: '2008789653-GNraHzM6' });
                        if (!liff.isLoggedIn()) {
                            liff.login();
                            return;
                        }
                        const it = liff.getDecodedIDToken();
                        let email = it ? it.email : null;
                        let userId = null;
                        if (!email) {
                            const p = await liff.getProfile();
                            userId = p.userId;
                        }
                        this.userId = userId;
                        await this.fetchData(email, userId);
                        this.isLoading = false;
                    } catch (err) {
                        console.error(err);
                        this.isLoading = false;
                    }
                },

                async fetchData(email, userId) {
                    try {
                        const res = await this.callAPI('getProfile', { email, userId });
                        if (res.success) {
                            this.profile = res.profile;
                        }
                    } catch (err) {
                        console.error(err);
                    }
                },

                async callAPI(action, params = {}) {
                    const query = new URLSearchParams({ action, ...params, userId: this.userId || '' }).toString();
                    const response = await fetch(`${WEB_APP_URL}?${query}`);
                    return await response.json();
                },

                get expPercentage() {
                    if (!this.profile.total_mp || !this.profile.next_rank_mp) return 0;
                    return Math.min(100, Math.round((this.profile.total_mp / this.profile.next_rank_mp) * 100));
                },

                getInitials(email) {
                    if (!email) return '..';
                    const name = email.split('@')[0];
                    if (name.includes('.')) {
                        const parts = name.split('.');
                        return (parts[0][0] + parts[1][0]).toUpperCase();
                    }
                    return name.substring(0, 2).toUpperCase();
                }
            }
        }
    </script>
</body>

</html>
