<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Daily Stat - RSU Dental</title>

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;300;400&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            rsu: {
              blue: '#1e40af',
              light: '#dbeafe',
              dark: '#1e3a8a'
            }
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer base {
      * {
        @apply leading-tight;
      }
      body {
        @apply leading-tight;
      }
    }
    @layer components {
            .glass-card {
                @apply bg-white/90 backdrop-blur-md border border-white/20 shadow-md rounded-2xl;
            }
            .nav-item {
                @apply flex flex-col items-center justify-center pt-2 pb-1 text-xs font-medium transition-colors duration-200;
            }
            .nav-item.active {
                @apply text-blue-600;
            }
            .nav-item:not(.active) {
                @apply text-gray-400 hover:text-gray-600;
            }
            .stat-value {
                @apply text-2xl font-bold text-gray-900;
            }
            .stat-label {
                @apply text-xs uppercase font-bold text-gray-400;
            }
            .rank-badge {
                @apply px-3 py-1 rounded-full text-xs font-bold text-white;
            }
            /* Custom Gradients from DailyRemover */
            .premium-gradient {
                @apply bg-gradient-to-br from-blue-600 via-indigo-600 to-violet-700;
            }
            .ticker-wrap {
                @apply w-full overflow-hidden bg-gray-900/5 py-2;
            }
            .ticker-move {
                display: inline-block;
                white-space: nowrap;
                padding-right: 100%;
                animation: ticker 120s linear infinite;
            }
            @keyframes ticker {
                0% { transform: translate3d(0, 0, 0); }
                100% { transform: translate3d(-100%, 0, 0); }
            }
            @keyframes revealGraph {
                0% {
                    clip-path: inset(0 100% 0 0);
                }
                100% {
                    clip-path: inset(0 0 0 0);
                }
            }
            .animate-reveal-graph {
                clip-path: inset(0 100% 0 0);
                animation: revealGraph 1.5s ease-out forwards;
            }
            [x-cloak] { display: none !important; }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-900 font-sans pb-24" x-data="dailyApp()" x-init="init()">


  <!-- MAIN_CONTENT_CONTAINER START -->
  <main class="px-5 mt-4 relative z-20 space-y-4">

    <!-- DYNAMIC_VIEWS START -->
    <div x-cloak>

      <!-- DASHBOARD_VIEW START -->
      <div x-show="activeTab === 'dashboard'" class="space-y-4">

        <!-- TOP_HEADER START -->
        <header
          :class="'bg-gradient-to-br ' + (rankConfig[profile.current_class]?.color || 'from-gray-400 to-gray-500') + ' text-white px-6 py-6 rounded-2xl shadow-lg relative overflow-hidden'">

          <div class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
          <div class="absolute bottom-0 left-0 -ml-10 -mb-10 w-48 h-48 bg-blue-400/20 rounded-full blur-2xl"></div>

          <div class="relative z-10 flex justify-between items-stretch">

            <div class="flex items-center gap-4">
              <!-- Profile Picture -->
              <div
                class="w-14 h-14 rounded-full border-2 border-white/50 overflow-hidden shadow-lg bg-white/20 flex-shrink-0">
                <template x-if="profile.pictureUrl">
                  <img :src="profile.pictureUrl" class="w-full h-full object-cover">
                </template>
                <template x-if="!profile.pictureUrl">
                  <div class="w-full h-full flex items-center justify-center text-xl font-bold bg-white/10 uppercase"
                    x-text="profile.display_name?.charAt(0) || '?' "></div>
                </template>
              </div>

              <div class="text-left flex flex-col justify-center">
                <div class="flex items-center gap-2">
                  <span class="text-xl leading-tight font-light"
                    style="font-family: 'Kanit', sans-serif; font-weight: 300;"
                    x-text="profile.display_name || 'Loading...'"></span>
                </div>
                <p class="text-[11px] opacity-70 mt-0.5 font-medium"
                  x-text="profile.email ? profile.email.split('@')[0] : ''"></p>
                <div class="flex items-center gap-1 mt-1 opacity-90">
                  <span x-html="deptIconMap[profile.department] || '<i class=\'fa-solid fa-building-user\'></i>'"
                    class="text-xs text-blue-200"></span>
                  <span class="text-[11px] font-black uppercase" x-text="profile.department || 'RSU Dental'"></span>
                </div>
              </div>
            </div>

            <div class="flex flex-col items-end justify-between text-right">

              <div class="flex items-center justify-end gap-1 w-fit ml-auto bg-transparent">
                <span class="text-base" x-text="rankConfig[profile.current_class]?.emoji || '‚ñ´Ô∏è'"></span>
                <span x-text="profile.current_class || 'Beginner'" class="text-xs font-bold uppercase"></span>
              </div>

              <div class="text-2xl leading-tight scale-110 origin-right drop-shadow-sm filter py-1"
                x-text="profile.current_title ? profile.current_title.replace(/[a-zA-Z].*/, '') : 'üî∞'">
              </div>

              <div class="text-[11px] font-bold opacity-90 uppercase"
                x-text="profile.current_title ? profile.current_title.replace(/^[^a-zA-Z]*/, '') : 'Rookie'">
              </div>

            </div>

          </div>
        </header>
        <!-- TOP_HEADER END -->

        <!-- DASHBOARD_STATS_ROW START -->
        <div class="grid grid-cols-3 gap-3">
          <div class="glass-card p-3 flex flex-col items-center">
            <div class="stat-label">Accuracy</div>
            <div class="stat-value text-purple-600 font-bold" x-text="(profile.recent_acc || 0) + '%'"></div>
          </div>
          <div class="glass-card p-3 flex flex-col items-center">
            <div class="stat-label">All-time Acc</div>
            <div class="stat-value text-emerald-600 font-bold" x-text="(profile.alltime_acc || 0) + '%'"></div>
          </div>
          <div class="glass-card p-3 flex flex-col items-center">
            <div class="stat-label">Consistency</div>
            <div class="stat-value text-orange-500 font-bold">
              <span x-text="profile.current_consistency || 0"></span>
              <i class="fa-solid fa-fire text-sm ml-0.5"></i>
            </div>
          </div>
        </div>
        <!-- DASHBOARD_STATS_ROW END -->

        <!-- TICKER_MESSAGES START -->
        <div class="ticker-wrap rounded-xl" x-show="system.ticker_messages?.length > 0">
          <div class="ticker-move text-[11px] font-bold text-blue-900/60 uppercase">
            <template x-for="msg in system.ticker_messages" :key="msg">
              <span class="mx-8 flex-inline items-center">
                <i class="fa-solid fa-bullhorn mr-2"></i>
                <span x-text="msg"></span>
              </span>
            </template>
          </div>
        </div>
        <!-- TICKER_MESSAGES END -->

        <!-- EXPERIENCE_PROGRESS START -->
        <div class="glass-card p-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
              <i class="fa-solid fa-bars-progress text-purple-500"></i>
              Experience
            </h3>
            <span class="text-xs font-bold text-gray-700" x-text="profile.current_title"></span>
          </div>
          <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden mb-2">
            <div class="h-full premium-gradient transition-all duration-1000 rounded-full"
              :style="'width: ' + (showExp ? expPercentage : 0) + '%'">
            </div>
          </div>
          <div class="flex justify-between text-xs font-bold text-gray-400">
            <span x-text="profile.total_exp?.toLocaleString() + ' EXP'"></span>
            <span
              x-text="profile.next_rank_exp ? 'Next: ' + (profile.next_rank_name || '') + ' (' + profile.next_rank_exp.toLocaleString() + ' EXP)' : 'Next: MAX'"></span>
          </div>
        </div>
        <!-- EXPERIENCE_PROGRESS END -->



        <!-- ACCURACY_TREND_GRAPH START -->
        <div class="glass-card p-4 pb-5 overflow-hidden">
          <div class="flex justify-between items-end mb-2">
            <h3 class="text-sm font-bold text-gray-800"><i
                class="fa-solid fa-chart-area text-cyan-600 mr-2"></i>Accuracy
              Trend</h3>
            <div class="flex items-center gap-1.5" x-show="profile.daily_history?.length > 1">
              <span class="text-xs font-black text-slate-700" x-text="(profile.alltime_acc || 0) + '%'"></span>
              <i class="fa-solid" :class="{
                   'fa-chevron-up text-emerald-500': trendDirection === 'up',
                   'fa-chevron-down text-rose-500': trendDirection === 'down',
                   'fa-minus text-gray-300': trendDirection === 'none'
                 }"></i>
            </div>
          </div>

          <div class="h-16 w-full relative" x-show="profile.daily_history && profile.daily_history.length > 1">
            <svg class="w-full h-full overflow-visible animate-reveal-graph" viewBox="0 0 100 40"
              preserveAspectRatio="none">
              <defs>
                <linearGradient id="trendGradient" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.25" />
                  <stop offset="100%" stop-color="#3b82f6" stop-opacity="0" />
                </linearGradient>
              </defs>
              <!-- Area Fill -->
              <path :d="trendFill" fill="url(#trendGradient)" stroke="none" />
              <!-- Line -->
              <path :d="trendPath" fill="none" stroke="#2563eb" stroke-width="2" stroke-opacity="0.5"
                vector-effect="non-scaling-stroke" stroke-linecap="butt" stroke-linejoin="round" />
            </svg>
          </div>

          <div x-show="!profile.daily_history || profile.daily_history.length < 2"
            class="h-16 flex items-center justify-center text-xs text-gray-300 italic">
            Not enough data for trend graph
          </div>
        </div>
        <!-- ACCURACY_TREND_GRAPH END -->

        <!-- REWARD_BOX START -->
        <div class="glass-card p-4">
          <h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-gift text-rose-500"></i>
            Reward Box
          </h3>
          <div class="grid grid-cols-8 gap-2 relative">
            <template x-for="item in groupedRewards" :key="item.fullName">
              <div @click="selectedReward = (selectedReward?.fullName === item.fullName ? null : item)"
                @click.outside="if(selectedReward?.fullName === item.fullName) selectedReward = null"
                class="aspect-square flex items-center justify-center text-xl relative cursor-pointer rounded-lg transition-all duration-200"
                :class="selectedReward?.fullName === item.fullName ? 'bg-rose-50 ring-2 ring-rose-200 scale-110 z-10' : 'hover:bg-gray-50'">
                <span x-text="item.emoji"></span>
                <div x-show="item.count > 1" class="absolute -top-1 -right-1 text-gray-400 text-xs font-black"
                  x-text="'√ó' + item.count">
                </div>

                <!-- Tooltip Popup -->
                <div x-show="selectedReward?.fullName === item.fullName" x-cloak
                  x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                  class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 z-[60] whitespace-nowrap">
                  <div class="bg-gray-800 text-white text-xs font-bold px-2 py-1 rounded shadow-lg relative">
                    <span x-text="item.displayName"></span>
                    <!-- Tooltip Arrow -->
                    <div
                      class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                    </div>
                  </div>
                </div>
              </div>
            </template>
            <div x-show="!profile.rewards?.length" class="col-span-8 py-8 text-center text-gray-300 text-xs italic">
              No rewards yet. Keep it up!
            </div>
          </div>
        </div>
        <!-- REWARD_BOX END -->
      </div>
      <!-- DASHBOARD_VIEW END -->

      <!-- LEADERBOARD_VIEW START -->
      <div x-show="activeTab === 'ranking'" class="space-y-3">

        <!-- DEPARTMENT_COMPARISON_CHART START -->
        <div class="glass-card p-4 sticky top-0 z-30 shadow-md">
          <h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-square-poll-horizontal text-blue-600"></i>
            Department All-time Accuracy
          </h3>
          <div class="space-y-2 mt-4">
            <template x-for="stat in orderedDeptStats" :key="stat.name">
              <div class="flex items-center gap-3">

                <!-- Department Name & Icon -->
                <div class="w-16 text-xs font-bold text-gray-500 flex items-center justify-end gap-1.5 shrink-0">
                  <span x-text="stat.name"></span>
                  <span x-html="deptIconMap[stat.name]" class="text-xs opacity-70"></span>
                </div>

                <!-- Progress Bar -->
                <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden relative">
                  <div class="h-full rounded-full transition-all duration-[1500ms] cubic-bezier(0.4, 0, 0.2, 1)"
                    :style="`width: ${showDeptAnim ? stat.accuracy : 0}%;`" :class="stat.name === profile.department
                      ? 'bg-gradient-to-r from-blue-600 to-sky-400 shadow-[0_0_8px_rgba(56,189,248,0.6)]'
                      : 'bg-gradient-to-r from-slate-300 to-slate-400 opacity-60'">
                  </div>
                </div>

                <!-- Percentage -->
                <div class="w-8 text-[12px] font-bold text-gray-400 text-right shrink-0" x-text="stat.accuracy + '%'">
                </div>

              </div>
            </template>
          </div>
        </div>
        <!-- DEPARTMENT_COMPARISON_CHART END -->

        <!-- LEADERBOARD_LIST START -->
        <div class="glass-card p-4 overflow-hidden">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
              <i class="fa-solid fa-ranking-star text-orange-600"></i>
              Leaderboard
            </h3>
            <span class="text-xs font-bold text-gray-400 uppercase">Top 20 Instructors</span>
          </div>
          <div class="mt-4">
            <template x-for="(user, idx) in leaderboard" :key="user.email">
              <div class="flex items-center gap-3 p-3 border-b border-gray-100 last:border-0"
                :class="user.email === profile.email ? 'bg-blue-50/50' : ''">
                <div class="w-8 h-8 flex items-center justify-center font-black text-sm rounded-lg"
                  :class="idx === 0 ? 'bg-yellow-100 text-yellow-700' : (idx === 1 ? 'bg-slate-100 text-slate-500' : (idx === 2 ? 'bg-orange-100 text-orange-700' : 'text-gray-400'))">
                  <span x-show="idx > 2" x-text="idx + 1"></span>
                  <i x-show="idx === 0" class="fa-solid fa-crown"></i>
                  <span x-show="idx === 1 || idx === 2" x-text="idx + 1"></span>
                </div>
                <div class="flex-1">
                  <div class="text-sm font-bold text-gray-800" x-text="user.display_name"></div>
                  <div class="text-xs text-gray-400 uppercase" x-text="user.current_title">
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-black text-blue-600" x-text="user.total_exp.toLocaleString()">
                  </div>
                  <div class="text-xs font-bold text-gray-300 uppercase">EXP Points</div>
                </div>
              </div>
            </template>
          </div>
        </div>
        <!-- LEADERBOARD_LIST END -->
      </div>
      <!-- LEADERBOARD_VIEW END -->


      <!-- PROFILE_VIEW START -->
      <div x-show="activeTab === 'profile'" class="space-y-4">
        <div class="glass-card p-6 flex items-center gap-6 relative z-30">
          <!-- Left side: Profile Picture -->
          <div
            class="w-20 h-20 rounded-full premium-gradient flex items-center justify-center text-3xl text-white shadow-xl border-4 border-white overflow-hidden bg-white/20 shrink-0">
            <template x-if="profile.pictureUrl">
              <img :src="profile.pictureUrl" class="w-full h-full object-cover">
            </template>
            <template x-if="!profile.pictureUrl">
              <span x-text="profile.display_name?.charAt(0) || '?'"></span>
            </template>
          </div>

          <!-- Right side: Info (Right aligned, Left aligned text) -->
          <div class="ml-auto flex flex-col items-start gap-1 text-right">
            <h2 class="text-md text-gray-800 font-light leading-tight"
              style="font-family: 'Kanit', sans-serif; font-weight: 300;" x-text="profile.display_name"></h2>
            <p class="text-xs font-bold text-gray-400 uppercase" x-text="classDisplay">
            </p>

            <div class="mt-1 text-xs font-bold text-gray-400 uppercase" x-text="profile.current_title || '---'"></div>

            <!-- Persona Badge -->
            <div @click="showPersonaTooltip = !showPersonaTooltip" @click.outside="showPersonaTooltip = false"
              class="mt-1 px-3 py-0.5 rounded-full bg-blue-50/50 border border-blue-100 flex items-center justify-center gap-1.5 w-max cursor-pointer relative transition-transform active:scale-95">
              <span class="text-xs" x-text="personaConfig.emoji"></span>
              <span class="text-xs font-black uppercase text-blue-600" x-text="personaConfig.name"></span>

              <!-- Persona Tooltip -->
              <div x-show="showPersonaTooltip" x-cloak x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                class="absolute top-full right-0 mt-2 z-[60] w-48 origin-top-right">
                <div class="bg-gray-800 text-white text-xs p-3 rounded-xl shadow-xl relative">
                  <!-- Arrow -->
                  <div class="absolute bottom-full right-4 border-4 border-transparent border-b-gray-800"></div>
                  <!-- Content -->
                  <div class="font-bold text-blue-200 mb-1" x-text="personaConfig.name"></div>
                  <div class="font-medium leading-tight text-gray-100" x-text="personaConfig.desc"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PRECISION_DASHBOARD_V2_START -->
        <div class="space-y-4 px-0">
          <div class="grid grid-cols-2 gap-4">
            <!-- GRADING_VITALS_V2 -->
            <div class="glass-card p-4 flex flex-col items-center justify-center h-24">
              <div class="stat-label">All Submissions</div>
              <div class="stat-value text-gray-700 font-bold">
                <span x-text="profile.total_cases_count || 0"></span>
                <span class="text-xs uppercase ml-1">Entries</span>
              </div>
            </div>

            <!-- AVG_PRECISION_V2 -->
            <div class="glass-card p-4 relative overflow-hidden h-24 flex flex-col items-center justify-center">
              <div class="w-full flex flex-col items-center text-center">
                <div class="stat-label">Avg. Precision</div>
                <div class="stat-value font-bold flex items-center justify-center gap-1.5"
                  :class="avgDelta <= 0 ? 'text-emerald-500' : 'text-orange-500'">
                  <span x-text="Math.abs(Math.round(avgDelta))"></span>
                  <div class="flex flex-col items-start leading-tight">
                    <span class="text-xs font-bold text-gray-300" x-show="sdDelta > 0"
                      x-text="'¬±' + Math.round(sdDelta) + ' SD'"></span>
                    <span class="text-xs font-bold uppercase" x-text="avgDelta <= 0 ? 'BEFORE' : 'AFTER'"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ADAPTIVE_STATUS_OVERDUE_ROW -->
          <div class="flex gap-4 items-stretch">
            <!-- SUBMISSION_STATUS_BAR_CARD -->
            <div class="glass-card px-5 py-4 flex flex-col justify-center transition-all duration-500"
              :class="profile.total_overdue > 0 ? 'w-2/3 h-24' : 'w-full'">
              <div class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden flex shadow-inner">
                <div class="h-full bg-gradient-to-r from-emerald-500 to-teal-400 transition-all duration-1000"
                  :style="'width: ' + (showProfileAnim ? onTimePercent : 0) + '%'"></div>
                <div class="h-full bg-gradient-to-r from-amber-400 to-orange-300 transition-all duration-1000"
                  x-show="profile.total_too_early > 0"
                  :style="'width: ' + (showProfileAnim ? tooEarlyPercent : 0) + '%'">
                </div>
                <div class="h-full bg-gradient-to-r from-rose-500 to-pink-400 transition-all duration-1000"
                  :style="'width: ' + (showProfileAnim ? overduePercent : 0) + '%'"></div>
              </div>
              <div class="flex justify-between mt-3 text-xs font-bold uppercase leading-tight">
                <div class="flex flex-col">
                  <span class="text-emerald-500 text-sm"
                    x-text="onTimePercent + '% (' + (profile.total_on_time || 0) + ')'"></span>
                  <span class="text-emerald-600/40">ON-TIME</span>
                </div>
                <div class="flex flex-col items-center" x-show="profile.total_too_early > 0">
                  <span class="text-amber-500 text-sm"
                    x-text="tooEarlyPercent + '% (' + (profile.total_too_early || 0) + ')'"></span>
                  <span class="text-amber-600/40">TOO EARLY</span>
                </div>
                <div class="flex flex-col items-end">
                  <span class="text-rose-500 text-sm"
                    x-text="overduePercent + '% (' + (profile.total_overdue || 0) + ')'"></span>
                  <span class="text-rose-600/40">OVERDUE</span>
                </div>
              </div>
            </div>

            <!-- OVERDUE_REPORT_CARD (1/3 Width Adaptive) -->
            <div
              class="glass-card px-3 py-2 flex flex-col items-center justify-center h-24 !bg-rose-50/90 w-1/3 border-rose-100"
              x-show="profile.total_overdue > 0">
              <div class="stat-label text-rose-600/70">Avg. Delay</div>
              <div class="stat-value text-rose-500 font-bold text-sm leading-tight"
                x-html="formatOverdueDelay(profile.avg_overdue_delay)"></div>
              <div class="stat-label text-rose-400 mt-1 whitespace-nowrap"
                x-text="(profile.total_overdue || 0) + ' Entries'"></div>
            </div>
          </div>

          <!-- SESSION_DISTRIBUTION_V2 -->
          <div class="glass-card p-5">
            <div class="flex items-center gap-2 mb-5">
              <i class="fa-solid fa-chart-simple text-blue-600/50"></i>
              <h3 class="text-sm font-bold text-gray-800">Session Distribution</h3>
            </div>

            <div class="space-y-2">
              <!-- MORNING -->
              <div>
                <div class="flex items-center gap-3">
                  <div class="w-6 flex flex-col items-center shrink-0">
                    <i class="fa-solid fa-sun text-cyan-400 text-sm"></i>
                  </div>
                  <div class="flex-1 h-1.5 bg-gray-50 rounded-full overflow-hidden">
                    <div
                      class="h-full bg-gradient-to-r from-cyan-400 to-blue-400 rounded-full transition-all duration-1000"
                      :style="'width: ' + (showProfileAnim ? sessionDist.m : 0) + '%'"></div>
                  </div>
                  <div class="w-16 text-right leading-tight">
                    <span class="text-xs font-black text-gray-400"
                      x-text="(profile.count_morning || 0) + ' entries'"></span>
                  </div>
                </div>
                <div class="flex items-center gap-3 -mt-1">
                  <div class="w-6"></div>
                  <div class="flex-1 text-right">
                    <span :class="avgMorningSameday.isLate ? 'text-rose-500' : 'text-emerald-500'"
                      class="text-xs font-black" x-text="'Avg. ' + avgMorningSameday.label"></span>
                    <span x-show="morningOverdueCount > 0" class="text-rose-400 text-xs font-black ml-2"
                      x-text="morningOverdueCount + ' overdue'"></span>
                  </div>
                </div>
              </div>

              <!-- AFTERNOON -->
              <div>
                <div class="flex items-center gap-3">
                  <div class="w-6 flex flex-col items-center shrink-0">
                    <i class="fa-solid fa-cloud-sun text-amber-400 text-sm"></i>
                  </div>
                  <div class="flex-1 h-1.5 bg-gray-50 rounded-full overflow-hidden">
                    <div
                      class="h-full bg-gradient-to-r from-amber-400 to-orange-300 rounded-full transition-all duration-1000"
                      :style="'width: ' + (showProfileAnim ? sessionDist.a : 0) + '%'"></div>
                  </div>
                  <div class="w-16 text-right leading-tight">
                    <span class="text-xs font-black text-gray-400"
                      x-text="(profile.count_afternoon || 0) + ' entries'"></span>
                  </div>
                </div>
                <div class="flex items-center gap-3 -mt-1">
                  <div class="w-6"></div>
                  <div class="flex-1 text-right">
                    <span :class="avgAfternoonSameday.isLate ? 'text-rose-500' : 'text-emerald-500'"
                      class="text-xs font-black" x-text="'Avg. ' + avgAfternoonSameday.label"></span>
                    <span x-show="afternoonOverdueCount > 0" class="text-rose-400 text-xs font-black ml-2"
                      x-text="afternoonOverdueCount + ' overdue'"></span>
                  </div>
                </div>
              </div>

              <!-- EVENING -->
              <div>
                <div class="flex items-center gap-3">
                  <div class="w-6 flex flex-col items-center shrink-0">
                    <i class="fa-solid fa-moon text-indigo-400 text-sm"></i>
                  </div>
                  <div class="flex-1 h-1.5 bg-gray-50 rounded-full overflow-hidden">
                    <div
                      class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-1000"
                      :style="'width: ' + (showProfileAnim ? sessionDist.e : 0) + '%'"></div>
                  </div>
                  <div class="w-16 text-right leading-tight">
                    <span class="text-xs font-black text-gray-400"
                      x-text="(profile.count_evening || 0) + ' entries'"></span>
                  </div>
                </div>
                <div class="flex items-center gap-3 -mt-1">
                  <div class="w-6"></div>
                  <div class="flex-1 text-right">
                    <span :class="avgEveningSameday.isLate ? 'text-rose-500' : 'text-emerald-500'"
                      class="text-xs font-black" x-text="'Avg. ' + avgEveningSameday.label"></span>
                    <span x-show="eveningOverdueCount > 0" class="text-rose-400 text-xs font-black ml-2"
                      x-text="eveningOverdueCount + ' overdue'"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- HOURLY_DISTRIBUTION_V2 -->
          <div class="glass-card p-5">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-center gap-2">
                <i class="fa-solid fa-clock text-indigo-500/50"></i>
                <h3 class="text-sm font-bold text-gray-800">24-Hr Submission</h3>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-xs font-black text-gray-400 uppercase">Peak:</span>
                <span class="text-xs font-black text-indigo-600"
                  x-text="hourlyStats.peakHour >= 0 ? (hourlyStats.peakHour.toString().padStart(2, '0') + ':00') : 'None'"></span>
              </div>
            </div>

            <div class="flex items-stretch justify-between h-24 gap-1 px-1">
              <template x-for="(count, hour) in hourlyStats.data" :key="hour">
                <div class="flex-1 flex flex-col items-center group relative h-full">
                  <!-- Bar Wrapper -->
                  <div class="w-full bg-gray-50 rounded-full overflow-hidden flex items-end h-full">
                    <div
                      class="w-full bg-gradient-to-t from-rose-500 to-pink-400 rounded-full transition-all duration-1000"
                      :style="'height: ' + (showProfileAnim ? (count / hourlyStats.max * 100) : 0) + '%'"
                      :title="hour + ':00 - ' + count + ' cases'">
                    </div>
                  </div>
                </div>
              </template>
            </div>

            <!-- X-Axis Labels -->
            <div class="relative mt-2 px-1">
              <div class="flex items-stretch justify-between">
                <template x-for="(count, hour) in hourlyStats.data" :key="'label-' + hour">
                  <div class="flex-1 flex justify-center">
                    <span x-show="[0, 9, 12, 16, 20, 23].includes(parseInt(hour))"
                      class="text-xs font-black text-gray-400 uppercase"
                      x-text="hour.toString().padStart(2, '0')"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- FOOTER -->
          <div class="py-10 flex flex-col items-center">
            <span class="text-xs font-black text-gray-200 uppercase">Efficiency Dashboard
              V2.0</span>
          </div>
        </div>
        <!-- PRECISION_DASHBOARD_END -->
      </div>
      <!-- PROFILE_VIEW END -->
      <!-- DYNAMIC_VIEWS END -->
  </main>
  <!-- MAIN_CONTENT_CONTAINER END -->

  <!-- BOTTOM_NAVIGATION START -->
  <nav
    class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-gray-100 px-10 safe-area-inset-bottom z-50">
    <div class="container mx-auto max-w-sm flex justify-between">
      <button @click="activeTab = 'dashboard'" class="nav-item" :class="activeTab === 'dashboard' ? 'active' : ''">
        <i class="fa-solid fa-gauge-high text-xl mb-1"></i>
        <span>Dashboard</span>
      </button>
      <button @click="activeTab = 'ranking'" class="nav-item" :class="activeTab === 'ranking' ? 'active' : ''">
        <i class="fa-solid fa-ranking-star text-xl mb-1"></i>
        <span>Ranking</span>
      </button>
      <button @click="activeTab = 'profile'" class="nav-item" :class="activeTab === 'profile' ? 'active' : ''">
        <i class="fa-solid fa-user text-xl mb-1"></i>
        <span>Profile</span>
      </button>
    </div>
  </nav>
  <!-- BOTTOM_NAVIGATION END -->

  <!-- RANKUP_CELEBRATION_MODAL START -->
  <div x-show="showRankup" x-cloak
    class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm"
    x-transition.opacity>
    <div class="glass-card w-full max-w-sm p-8 text-center relative overflow-hidden"
      x-transition:enter="transition ease-out duration-500 scale-90 opacity-0"
      x-transition:enter-start="scale-90 opacity-0" x-transition:enter-end="scale-100 opacity-100">

      <div class="absolute top-0 left-0 w-full h-2 premium-gradient"></div>

      <div class="text-6xl mb-4 animate-bounce">üéä</div>
      <h2 class="text-2xl font-black text-gray-800 mb-2" x-text="'RANK UP: ' + profile.current_class"></h2>
      <p class="text-gray-500 text-sm mb-6">Congratulations! You've reached a higher rank.</p>

      <div
        :class="'inline-flex items-center px-6 py-2 rounded-full text-white font-black shadow-lg mb-8 bg-gradient-to-r ' + (rankConfig[profile.current_class]?.color || 'from-blue-600 to-indigo-600')">
        <span x-text="rankConfig[profile.current_class]?.emoji || 'üèÜ'"></span>
        <span x-text="profile.current_class" class="ml-2 uppercase text-lg"></span>
      </div>

      <button @click="closeRankup()"
        class="w-full py-4 premium-gradient text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
        Got it, let's go!
      </button>
    </div>
  </div>
  <!-- RANKUP_CELEBRATION_MODAL END -->

  <!-- LOADING_OVERLAY START -->
  <div x-show="isLoading" x-cloak
    class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center space-y-4">
    <div class="w-16 h-16 relative">
      <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
      <div class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
    </div>
  </div>
  <!-- LOADING_OVERLAY END -->

  <script>
    const WEB_APP_URL = 'https://script.google.com/a/macros/rsu.ac.th/s/AKfycbxWTt29Ry2K8upGAFQV1rnxFnDHB9IUb4ahim3tZXFVvOUZv3jqxrrQnZ61NbTz6CdmHA/exec'; // REPLACE WITH ACTUAL URL

    function dailyApp() {
      return {
        activeTab: 'dashboard',
        selectedReward: null,
        isLoading: true,
        showRankup: false,
        profile: {},
        userId: null,
        system: {},
        leaderboard: [],
        recentScores: [],
        showExp: false,
        showDeptAnim: false,
        showProfileAnim: false,
        showPersonaTooltip: false,


        statusColors: {
          'perfect': 'bg-gradient-to-r from-cyan-500 to-blue-500',
          'good': 'bg-gradient-to-r from-emerald-500 to-teal-500',
          'fair': 'bg-gradient-to-r from-amber-500 to-orange-500',
          'overdue': 'bg-gradient-to-r from-rose-500 to-pink-500',
          'error': 'bg-gray-400'
        },

        rankConfig: {
          'Diamond': { emoji: 'üíé', color: 'from-cyan-400 to-blue-500' },
          'Platinum': { emoji: '‚óªÔ∏è', color: 'from-emerald-400 to-teal-500' },
          'Gold': { emoji: 'ü•á', color: 'from-yellow-400 to-orange-500' },
          'Silver': { emoji: 'ü•à', color: 'from-slate-300 to-slate-400' },
          'Bronze': { emoji: 'ü•â', color: 'from-orange-700 to-amber-900' },
          'Beginner': { emoji: '‚ñ´Ô∏è', color: 'from-gray-400 to-gray-500' }
        },

        deptIconMap: {
          'Endo': '<i class="fa-solid fa-thumbtack"></i>',
          'Oper': '<i class="fa-solid fa-tooth"></i>',
          'Diag': '<i class="fa-solid fa-magnifying-glass"></i>',
          'Ortho': '<i class="fa-solid fa-face-grimace"></i>',
          'Pedo': '<i class="fa-solid fa-children"></i>',
          'Perio': '<i class="fa-solid fa-teeth"></i>',
          'Prosth': '<i class="fa-solid fa-teeth-open"></i>',
          'Radio': '<i class="fa-solid fa-skull"></i>',
          'Surg': '<i class="fa-solid fa-head-side-mask"></i>'
        },

        get orderedDeptStats() {
          const order = ['Perio', 'Oper', 'Endo', 'Prosth', 'Radio', 'Pedo', 'Ortho', 'Surg'];
          const stats = this.system.dept_stats || {};
          return order.map(name => ({
            name,
            accuracy: stats[name]?.accuracy || 0
          }));
        },

        get expPercentage() {
          if (!this.profile.total_exp || !this.profile.next_rank_exp) return 0;
          const current = this.profile.total_exp;
          const next = this.profile.next_rank_exp;
          if (next <= current) return 100;
          return Math.min(100, Math.round((current / next) * 100));
        },


        get groupedRewards() {
          const rewards = this.profile.rewards || [];
          const counts = {};
          rewards.forEach(r => {
            counts[r] = (counts[r] || 0) + 1;
          });
          return Object.keys(counts).map(key => ({
            fullName: key,
            count: counts[key],
            emoji: key.split(' ')[0],
            displayName: key.split(' ').slice(1).join(' ')
          }));
        },

        get trendPath() {
          const history = this.profile.daily_history || [];
          if (history.length < 2) return '';

          const width = 100;
          const height = 40; // SVG height
          const step = width / (history.length - 1);

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å
          let prevX = 0;
          let prevY = height - (history[0].a / 100 * height);

          let path = `M ${prevX},${prevY}`;

          // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏á
          for (let i = 1; i < history.length; i++) {
            const currentX = i * step;
            const currentY = height - (history[i].a / 100 * height);

            // ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ: ‡∏™‡∏£‡πâ‡∏≤‡∏á Control Point ‡∏ó‡∏µ‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2 ‡∏à‡∏∏‡∏î
            // cp1X = ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ó‡∏≤‡∏á
            // cp2X = ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ó‡∏≤‡∏á
            const cp1X = prevX + (currentX - prevX) / 2;
            const cp1Y = prevY; // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°

            const cp2X = prevX + (currentX - prevX) / 2;
            const cp2Y = currentY; // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà

            // C = Cubic Bezier Curve
            path += ` C ${cp1X},${cp1Y} ${cp2X},${cp2Y} ${currentX},${currentY}`;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            prevX = currentX;
            prevY = currentY;
          }

          return path;
        },

        get trendFill() {
          const path = this.trendPath;
          if (!path) return '';
          return `${path} L 100,40 L 0,40 Z`;
        },

        get trendDirection() {
          const history = this.profile.daily_history || [];
          if (history.length < 2) return 'none';
          const last = history[history.length - 1].a;
          const prev = history[history.length - 2].a;
          if (last > prev) return 'up';
          if (last < prev) return 'down';
          return 'none';
        },

        formatDelta(minutes) {
          const abs = Math.abs(Math.round(minutes));
          if (abs < 60) return abs + 'm';
          const h = Math.floor(abs / 60);
          const m = abs % 60;
          return h + 'h ' + m + 'm';
        },

        get avgMorning() {
          const count = this.profile.count_morning || 0;
          const deltaSum = this.profile.total_morning_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get avgAfternoon() {
          const count = this.profile.count_afternoon || 0;
          const deltaSum = this.profile.total_afternoon_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get avgEvening() {
          const count = this.profile.count_evening || 0;
          const deltaSum = this.profile.total_evening_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get onTimePercent() {
          const total = this.profile.total_cases_count || 0;
          if (total === 0) return 0;
          return Math.round((this.profile.total_on_time || 0) / total * 100);
        },

        get overduePercent() {
          const total = this.profile.total_cases_count || 0;
          if (total === 0) return 0;
          return Math.round((this.profile.total_overdue || 0) / total * 100);
        },

        get tooEarlyPercent() {
          const total = this.profile.total_cases_count || 0;
          if (total === 0) return 0;
          return Math.round((this.profile.total_too_early || 0) / total * 100);
        },

        get avgDelta() {
          // Use same-day count only (excluding overdue)
          const count = this.profile.count_sameday || 0;
          if (count <= 0) return 0;
          return this.profile.total_sameday_delta / count;
        },

        get sdDelta() {
          const count = this.profile.count_sameday || 0;
          if (count <= 1) return 0;
          const avg = this.avgDelta;
          const meanSq = this.profile.total_sameday_delta_sq / count;
          const variance = meanSq - (avg * avg);
          return Math.sqrt(Math.max(0, variance));
        },

        get morningAvgDelta() {
          const count = this.profile.count_morning || 0;
          if (count === 0) return 0;
          return this.profile.total_morning_delta / count;
        },

        get hourlyStats() {
          let raw = [];
          try {
            const field = this.profile.hourly_dist_json;
            raw = typeof field === 'string' ? JSON.parse(field || '[]') : (field || []);
          } catch (e) {
            console.error('Error parsing hourly_dist_json', e);
            raw = [];
          }
          // Ensure it's an array of length 24 and all values are numbers
          const data = (Array.isArray(raw) && raw.length === 24)
            ? raw.map(v => Number(v) || 0)
            : new Array(24).fill(0);

          const maxVal = Math.max(...data);
          const max = maxVal > 0 ? maxVal : 1;
          const peakHour = maxVal > 0 ? data.indexOf(maxVal) : -1;
          return { data, max, peakHour };
        },

        // Overdue count computed properties
        get morningOverdueCount() {
          return (this.profile.count_morning || 0) - (this.profile.count_morning_sameday || 0);
        },

        get afternoonOverdueCount() {
          return (this.profile.count_afternoon || 0) - (this.profile.count_afternoon_sameday || 0);
        },

        get eveningOverdueCount() {
          return (this.profile.count_evening || 0) - (this.profile.count_evening_sameday || 0);
        },

        // Same-day session averages
        get avgMorningSameday() {
          const count = this.profile.count_morning_sameday || 0;
          const deltaSum = this.profile.total_morning_sameday_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get avgAfternoonSameday() {
          const count = this.profile.count_afternoon_sameday || 0;
          const deltaSum = this.profile.total_afternoon_sameday_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        get avgEveningSameday() {
          const count = this.profile.count_evening_sameday || 0;
          const deltaSum = this.profile.total_evening_sameday_delta || 0;
          if (count === 0) return { label: 'No Data', isLate: false };
          const avg = deltaSum / count;
          return {
            label: this.formatDelta(avg) + (avg <= 0 ? ' before' : ' after'),
            isLate: avg > 0
          };
        },

        formatOverdueDelay(minutes) {
          if (!minutes || minutes <= 0) return '0 mins';

          const totalMinutes = Math.round(minutes);

          // If less than 1 hour, show minutes only
          if (totalMinutes < 60) {
            return `${totalMinutes} mins`;
          }

          // If less than 1 day, show hours and minutes
          if (totalMinutes < 1440) { // 1440 = 24 hours
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
          }

          // If 1 day or more, show days, hours, and minutes
          const days = Math.floor(totalMinutes / 1440);
          const remainingMins = totalMinutes % 1440;
          const hours = Math.floor(remainingMins / 60);
          const mins = remainingMins % 60;

          let result = `${days}d`;
          if (hours > 0) result += ` ${hours}h`;
          if (mins > 0) result += ` ${mins}m`;

          return result;
        },

        get classDisplay() {
          const c = (this.profile.current_class || 'Beginner');
          const emojis = { 'Diamond': 'üíé', 'Platinum': '‚óªÔ∏è', 'Gold': 'ü•á', 'Silver': 'ü•à', 'Bronze': 'ü•â', 'Beginner': '‚ñ´Ô∏è' };
          return (emojis[c] || '') + c + ' Class';
        },

        get sessionDist() {
          const total = this.profile.total_cases_count || 0;
          if (total === 0) return { m: 0, a: 0, e: 0 };
          return {
            m: Math.round((this.profile.count_morning || 0) / total * 100),
            a: Math.round((this.profile.count_afternoon || 0) / total * 100),
            e: Math.round((this.profile.count_evening || 0) / total * 100)
          };
        },

        get personaConfig() {
          const avg = this.avgDelta;
          if (avg <= 0) return { name: 'The Flash', emoji: '‚ö°', desc: 'Lightning fast! You always finish your work on or before the target time.' };
          if (avg <= 60) return { name: 'The Slow-burner', emoji: 'üßò', desc: 'Slow but steady. You might be a bit after the target, but you always arrive within the hour!' };
          return { name: 'The Deadline Diver', emoji: 'ü§ø', desc: 'Better late than never! You usually pass the 60-minute mark, but hey, you got it done!' };
        },

        triggerTabAnimations(tab) {
          if (tab === 'dashboard') {
            if (this.showExp) this.showExp = false;
            this.$nextTick(() => {
              setTimeout(() => {
                this.showExp = true;
              }, 50);
            });
          } else if (tab === 'ranking') {
            if (this.showDeptAnim) this.showDeptAnim = false;
            this.$nextTick(() => {
              setTimeout(() => this.showDeptAnim = true, 50);
            });
          } else if (tab === 'profile') {
            if (this.showProfileAnim) this.showProfileAnim = false;
            this.$nextTick(() => {
              setTimeout(() => this.showProfileAnim = true, 50);
            });
          }
        },

        async init() {
          try {
            await liff.init({ liffId: '2008789653-GNraHzM6' });
            if (!liff.isLoggedIn()) {
              liff.login();
              return;
            }

            const idToken = liff.getDecodedIDToken();
            let email = idToken ? idToken.email : null;
            let userId = null;
            let pictureUrl = idToken ? idToken.picture : null;

            if (!email || !pictureUrl) {
              const liffProfile = await liff.getProfile();
              userId = liffProfile.userId;
              pictureUrl = liffProfile.pictureUrl;
            }

            console.log('Auth Identifier:', email || userId);
            await this.fetchData(email || undefined, userId || undefined, pictureUrl);

            this.isLoading = false;

            // Check for rank up celebration
            if (this.profile.is_rank_up) {
              setTimeout(() => this.showRankup = true, 500);
            }

            this.$nextTick(() => {
              // Watch for tab changes to reset animations
              this.$watch('activeTab', (value) => {
                this.triggerTabAnimations(value);
              });

              // Trigger initial animations for default tab
              this.triggerTabAnimations(this.activeTab);
            });

          } catch (err) {
            console.error('Initialization failed', err);
            alert('Initialization Error: ' + err.message);
            this.isLoading = false;
          }
        },

        async fetchData(email, userId, pictureUrl) {
          try {
            const [profileRes, leaderboardRes] = await Promise.all([
              this.callAPI('getProfile', { email, userId }),
              this.callAPI('getLeaderboard', { limit: 20 })
            ]);

            console.log('Profile Response:', profileRes);

            if (profileRes.success) {
              const profile = profileRes.profile;
              // Consolidate data into a single reactive update
              if (pictureUrl) profile.pictureUrl = pictureUrl;
              if (userId && !profile.userId) profile.userId = userId;

              this.profile = profile;
              this.recentScores = JSON.parse(this.profile.recent_scores_json || '[]');
              this.system = profileRes.system; // Use system data from profile response
              if (leaderboardRes.success) {
                this.leaderboard = leaderboardRes.leaderboard;
              }
            } else {
              console.warn('Profile fetch failed:', profileRes);
              alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: ' + (profileRes.message || 'Unknown error'));
            }
          } catch (err) {
            console.error('Fetch data failed', err);
          }
        },

        async callAPI(action, params = {}) {
          try {
            // Use userId from state if not provided and profile not yet set
            const activeUserId = params.userId || this.userId || (this.profile && this.profile.userId);
            if (activeUserId && !params.userId) {
              params.userId = activeUserId;
            }

            const query = new URLSearchParams({ action, ...params }).toString();
            const response = await fetch(`${WEB_APP_URL}?${query}`);
            return await response.json();
          } catch (err) {
            console.error(`API Call failed: ${action}`, err);
            return { success: false, message: err.message };
          }
        },


        formatThaiDate(dateStr) {
          if (!dateStr) return '---';
          const date = new Date(dateStr);
          const day = date.getDate();
          const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
          const month = monthNames[date.getMonth()];
          const thaiYear = ((date.getFullYear() + 543) % 100).toString().padStart(2, '0');
          return `${day} ${month} ${thaiYear}`;
        },

        async closeRankup() {
          this.showRankup = false;
          await this.callAPI('clearRankUp', { email: this.profile.email });
        },


      }
    }
  </script>
</body>

</html>